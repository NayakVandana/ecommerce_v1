import { useState, useEffect, useRef } from 'react';
import { usePage, router } from '@inertiajs/react';
import { useProductStore } from './useProductStore';
import { useCategoryStore } from '../Category/useCategoryStore';
import AdminLayout from '../Layout';
import toast from '../../../utils/toast';
import { ArrowLeftIcon, XMarkIcon, PlusIcon, TrashIcon, VideoCameraIcon, PhotoIcon } from '@heroicons/react/24/outline';
import { useDropzone } from 'react-dropzone';
import { SketchPicker } from 'react-color';

export default function ProductCreate() {
    const { props } = usePage();
    const productId = (props as any).id;
    const isEditMode = !!productId;
    
    const [categories, setCategories] = useState<any[]>([]);
    const [filteredCategories, setFilteredCategories] = useState<any[]>([]);
    const [categorySearch, setCategorySearch] = useState('');
    const [selectedMainCategory, setSelectedMainCategory] = useState<string>('');
    const [selectedSubCategory, setSelectedSubCategory] = useState<string>('');
    const [selectedSubSubCategory, setSelectedSubSubCategory] = useState<string>('');
    const [product, setProduct] = useState<any>(null);
    const [loading, setLoading] = useState(false);
    const [formData, setFormData] = useState({
        product_name: '',
        description: '',
        price: '',
        category: '',
        total_quantity: '',
        is_approve: 0,
        is_returnable: false,
        is_replaceable: false,
        return_policy_note: '',
    });
    const [errors, setErrors] = useState<any>({});
    const [submitting, setSubmitting] = useState(false);
    const [media, setMedia] = useState<any[]>([]);
    const [uploadingMedia, setUploadingMedia] = useState(false);
    const [variations, setVariations] = useState<any[]>([]);
    const [mediaColor, setMediaColor] = useState('');
    const [pendingMediaFiles, setPendingMediaFiles] = useState<File[]>([]);
    const [showColorPicker, setShowColorPicker] = useState(false);
    const [mediaColorPickers, setMediaColorPickers] = useState<{ [key: number]: boolean }>({});
    const [variationColorPickers, setVariationColorPickers] = useState<{ [key: number]: boolean }>({});
    const [variationColors, setVariationColors] = useState<{ [key: number]: string }>({});
    const [activeMediaTab, setActiveMediaTab] = useState<'images' | 'video'>('images');
    const [pendingImages, setPendingImages] = useState<File[]>([]);
    const [pendingVideos, setPendingVideos] = useState<File[]>([]);
    const [selectedVariationForMedia, setSelectedVariationForMedia] = useState<number | null>(null);
    const [activeMainTab, setActiveMainTab] = useState<'media' | 'variations'>('media');
    const [pendingVariationMedia, setPendingVariationMedia] = useState<{ [key: number]: File[] }>({});
    const [uploadingVariationMedia, setUploadingVariationMedia] = useState<{ [key: number]: boolean }>({});
    const hasAutoGeneratedRef = useRef(false);

    useEffect(() => {
        loadCategories();
        if (isEditMode && productId) {
            loadProduct();
        }
    }, [productId]);

    useEffect(() => {
        if (product) {
            setFormData({
                product_name: product.product_name || '',
                description: product.description || '',
                price: product.price || '',
                category: product.category || '',
                total_quantity: product.total_quantity || '',
                is_approve: product.is_approve || 0,
                is_returnable: product.is_returnable !== undefined ? product.is_returnable : false,
                is_replaceable: product.is_replaceable !== undefined ? product.is_replaceable : false,
                return_policy_note: product.return_policy_note || '',
            });
            
            // Set category hierarchy based on selected category
            if (product.category && categories.length > 0) {
                const selectedCat = categories.find((c: any) => c.id === parseInt(product.category));
                if (selectedCat) {
                    // Find the category path (main -> sub -> sub-sub)
                    if (selectedCat.parent_id) {
                        const parent = categories.find((c: any) => c.id === selectedCat.parent_id);
                        if (parent) {
                            if (parent.parent_id) {
                                // 3 levels: main -> sub -> sub-sub
                                setSelectedMainCategory(parent.parent_id.toString());
                                setSelectedSubCategory(parent.id.toString());
                                setSelectedSubSubCategory(selectedCat.id.toString());
                            } else {
                                // 2 levels: main -> sub
                                setSelectedMainCategory(parent.id.toString());
                                setSelectedSubCategory(selectedCat.id.toString());
                                setSelectedSubSubCategory('');
                            }
                        }
                    } else {
                        // Main category only
                        setSelectedMainCategory(selectedCat.id.toString());
                        setSelectedSubCategory('');
                        setSelectedSubSubCategory('');
                    }
                }
            }
            
            // Format media URLs to ensure they're properly displayed
            const formattedMedia = (product.media || []).map((item: any) => ({
                ...item,
                url: item.url || (item.file_path ? `/storage/${item.file_path}` : null)
            }));
            setMedia(formattedMedia);
            
            setVariations(product.variations || []);
            // Reset auto-generation flag when product is loaded (edit mode)
            if (product.variations && product.variations.length > 0) {
                hasAutoGeneratedRef.current = true;
            }
        }
    }, [product, categories]);

    // Auto-generation removed - variations are now added manually only

    const loadCategories = async () => {
        try {
            const response = await useCategoryStore.list();
            console.log('Category API Response:', response.data);
            
            if (response.data?.status) {
                // Use flat list for easier selection
                const flatCategories = response.data.data?.flat || response.data.data || [];
                console.log('Loaded categories:', flatCategories.length, flatCategories);
                
                if (flatCategories.length === 0) {
                    console.warn('No categories found in response');
                }
                
                setCategories(flatCategories);
                setFilteredCategories(flatCategories);
            } else {
                console.error('Category API returned non-success status:', response.data);
            }
        } catch (error) {
            console.error('Error loading categories:', error);
            toast({ message: 'Failed to load categories', type: 'error' });
        }
    };

    // Filter categories based on search while maintaining hierarchy
    useEffect(() => {
        if (categorySearch.trim() === '') {
            setFilteredCategories(categories);
        } else {
            const searchLower = categorySearch.toLowerCase();
            const matchedIds = new Set<number>();
            
            // First, find all categories that match the search
            categories.forEach((cat: any) => {
                if (cat.name.toLowerCase().includes(searchLower)) {
                    matchedIds.add(cat.id);
                    
                    // If this is a child category, include its parent
                    if (cat.parent_id) {
                        matchedIds.add(cat.parent_id);
                        // Also include grandparent if exists
                        const parent = categories.find((c: any) => c.id === cat.parent_id);
                        if (parent && parent.parent_id) {
                            matchedIds.add(parent.parent_id);
                        }
                    }
                    
                    // If this is a parent category, include all its children
                    const children = categories.filter((c: any) => c.parent_id === cat.id);
                    children.forEach((child: any) => {
                        matchedIds.add(child.id);
                        // Include grandchildren too
                        const grandchildren = categories.filter((c: any) => c.parent_id === child.id);
                        grandchildren.forEach((grandchild: any) => {
                            matchedIds.add(grandchild.id);
                        });
                    });
                }
            });
            
            // Filter categories to include matched ones and maintain hierarchy
            const filtered = categories.filter((cat: any) => matchedIds.has(cat.id));
            setFilteredCategories(filtered);
        }
    }, [categorySearch, categories]);

    // Get category display name with hierarchy
    const getCategoryDisplayName = (category: any): string => {
        if (!category.parent_id) {
            return category.name;
        }
        
        const parent = categories.find((c: any) => c.id === category.parent_id);
        if (!parent) {
            return category.name;
        }
        
        // Check if parent has a parent (3 levels)
        if (parent.parent_id) {
            const grandParent = categories.find((c: any) => c.id === parent.parent_id);
            if (grandParent) {
                return `${grandParent.name} > ${parent.name} > ${category.name}`;
            }
        }
        
        return `${parent.name} > ${category.name}`;
    };

    // Build hierarchical category options for display
    const buildCategoryOptions = () => {
        if (!filteredCategories || filteredCategories.length === 0) {
            console.warn('No filtered categories available for dropdown');
            return [<option key="no-categories" value="" disabled>No categories available</option>];
        }
        
        const options: JSX.Element[] = [];
        const mainCategories = filteredCategories.filter((cat: any) => !cat.parent_id);
        
        if (mainCategories.length === 0) {
            // If no main categories, show all categories (might be all subcategories)
            filteredCategories.forEach((cat: any) => {
                options.push(
                    <option key={cat.id} value={cat.id}>
                        {cat.name}
                    </option>
                );
            });
            return options;
        }
        
        // Sort main categories by sort_order and name
        const sortedMainCategories = [...mainCategories].sort((a: any, b: any) => {
            if (a.sort_order !== b.sort_order) {
                return (a.sort_order || 0) - (b.sort_order || 0);
            }
            return (a.name || '').localeCompare(b.name || '');
        });
        
        sortedMainCategories.forEach((mainCat: any) => {
            // Add main category
            options.push(
                <option key={mainCat.id} value={mainCat.id}>
                    {mainCat.name}
                </option>
            );
            
            // Add subcategories
            const subCategories = filteredCategories
                .filter((cat: any) => cat.parent_id === mainCat.id)
                .sort((a: any, b: any) => {
                    if (a.sort_order !== b.sort_order) {
                        return (a.sort_order || 0) - (b.sort_order || 0);
                    }
                    return (a.name || '').localeCompare(b.name || '');
                });
            
            subCategories.forEach((subCat: any) => {
                // Add subcategory
                options.push(
                    <option key={subCat.id} value={subCat.id}>
                        &nbsp;&nbsp;└─ {subCat.name}
                    </option>
                );
                
                // Add sub-subcategories
                const subSubCategories = filteredCategories
                    .filter((cat: any) => cat.parent_id === subCat.id)
                    .sort((a: any, b: any) => {
                        if (a.sort_order !== b.sort_order) {
                            return (a.sort_order || 0) - (b.sort_order || 0);
                        }
                        return (a.name || '').localeCompare(b.name || '');
                    });
                
                subSubCategories.forEach((subSubCat: any) => {
                    options.push(
                        <option key={subSubCat.id} value={subSubCat.id}>
                            &nbsp;&nbsp;&nbsp;&nbsp;└─ {subSubCat.name}
                        </option>
                    );
                });
            });
        });
        
        return options;
    };

    const loadProduct = async () => {
        try {
            setLoading(true);
            const response = await useProductStore.show({ id: productId });
            if (response.data?.status && response.data?.data) {
                setProduct(response.data.data);
            }
        } catch (error) {
            console.error('Error loading product:', error);
            toast({ message: 'Failed to load product', type: 'error' });
            router.visit('/admin/products');
        } finally {
            setLoading(false);
        }
    };

    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        const { name, value, type } = e.target;
        const checked = (e.target as HTMLInputElement).checked;
        
        // Handle boolean checkboxes differently
        if (name === 'is_returnable') {
            setFormData(prev => ({
                ...prev,
                [name]: checked
            }));
        } else {
            setFormData(prev => ({
                ...prev,
                [name]: type === 'checkbox' ? (checked ? 1 : 0) : value
            }));
        }

        // Clear error for this field
        if (errors[name]) {
            setErrors((prev: any) => {
                const newErrors = { ...prev };
                delete newErrors[name];
                return newErrors;
            });
        }

        // Handle category selection changes
        if (name === 'category') {
            const selectedCategory = categories.find((cat: any) => cat.id === parseInt(value));
            if (selectedCategory && selectedCategory.name.toLowerCase() !== 'fashion') {
                setVariations([]);
                hasAutoGeneratedRef.current = false;
            }
        }
        
        // Handle cascading category selection
        if (name === 'main_category') {
            setSelectedMainCategory(value);
            setSelectedSubCategory('');
            setSelectedSubSubCategory('');
            // Set the final category to main category if no subcategories
            const mainCat = categories.find((c: any) => c.id === parseInt(value));
            if (mainCat) {
                const hasSubcategories = categories.some((c: any) => c.parent_id === mainCat.id);
                if (!hasSubcategories) {
                    setFormData(prev => ({ ...prev, category: value }));
                } else {
                    setFormData(prev => ({ ...prev, category: '' }));
                }
            }
        }
        
        if (name === 'sub_category') {
            setSelectedSubCategory(value);
            setSelectedSubSubCategory('');
            // Set the final category to subcategory if no sub-subcategories
            const subCat = categories.find((c: any) => c.id === parseInt(value));
            if (subCat) {
                const hasSubSubcategories = categories.some((c: any) => c.parent_id === subCat.id);
                if (!hasSubSubcategories) {
                    setFormData(prev => ({ ...prev, category: value }));
                } else {
                    setFormData(prev => ({ ...prev, category: '' }));
                }
            }
        }
        
        if (name === 'sub_sub_category') {
            setSelectedSubSubCategory(value);
            setFormData(prev => ({ ...prev, category: value }));
        }
        
        // Handle cascading category selection
        if (name === 'main_category') {
            setSelectedMainCategory(value);
            setSelectedSubCategory('');
            setSelectedSubSubCategory('');
            // Set the final category to main category if no subcategories
            const mainCat = categories.find((c: any) => c.id === parseInt(value));
            if (mainCat) {
                const hasSubcategories = categories.some((c: any) => c.parent_id === mainCat.id);
                if (!hasSubcategories) {
                    setFormData(prev => ({ ...prev, category: value }));
                } else {
                    setFormData(prev => ({ ...prev, category: '' }));
                }
            }
        }
        
        if (name === 'sub_category') {
            setSelectedSubCategory(value);
            setSelectedSubSubCategory('');
            // Set the final category to subcategory if no sub-subcategories
            const subCat = categories.find((c: any) => c.id === parseInt(value));
            if (subCat) {
                const hasSubSubcategories = categories.some((c: any) => c.parent_id === subCat.id);
                if (!hasSubSubcategories) {
                    setFormData(prev => ({ ...prev, category: value }));
                } else {
                    setFormData(prev => ({ ...prev, category: '' }));
                }
            }
        }
        
        if (name === 'sub_sub_category') {
            setSelectedSubSubCategory(value);
            setFormData(prev => ({ ...prev, category: value }));
        }
    };

    // Check if current category is Fashion
    const isFashionCategory = () => {
        const selectedCategory = categories.find((cat: any) => cat.id === parseInt(formData.category));
        return selectedCategory && selectedCategory.name.toLowerCase() === 'fashion';
    };

    // Check if a variation already exists (duplicate check based on size, color, and gender)
    const isDuplicateVariation = (size: string, color: string, gender: string, excludeIndex?: number): boolean => {
        return variations.some((v: any, index: number) => {
            if (excludeIndex !== undefined && index === excludeIndex) return false;
            
            // Normalize empty strings, null, and undefined values for comparison
            const normalize = (val: any): string => {
                if (val === null || val === undefined) return '';
                return String(val).trim().toLowerCase();
            };
            
            const vSize = normalize(v.size);
            const vColor = normalize(v.color);
            const vGender = normalize(v.gender);
            const checkSize = normalize(size);
            const checkColor = normalize(color);
            const checkGender = normalize(gender);

            // Both size and color must match (case-insensitive)
            const sizeColorMatch = vSize === checkSize && vColor === checkColor;

            // If both variations have gender specified, they must match
            // If one has gender and the other doesn't, they're different
            if (checkGender !== '' && vGender !== '') {
                // Both have gender - all three (size, color, gender) must match
                return sizeColorMatch && vGender === checkGender;
            } else if (checkGender === '' && vGender === '') {
                // Neither has gender - check only size and color
                return sizeColorMatch;
        } else {
                // One has gender, the other doesn't - they're different (not duplicates)
                return false;
        }
        });
    };


    const onDrop = (acceptedFiles: File[]) => {
        if (acceptedFiles.length === 0) return;

        const currentProductId = productId || (product?.id);
        
        // Separate images and videos
        const images = acceptedFiles.filter(file => file.type.startsWith('image/'));
        const videos = acceptedFiles.filter(file => file.type.startsWith('video/'));
        
        // If product exists, upload immediately
        if (currentProductId) {
            uploadMediaFiles(acceptedFiles, currentProductId, selectedVariationForMedia);
        } else {
            // Store files for later upload after product creation
            // Use functional updates to avoid race conditions
            setPendingMediaFiles(prev => [...prev, ...acceptedFiles]);
            setPendingImages(prev => [...prev, ...images]);
            setPendingVideos(prev => [...prev, ...videos]);
            toast({ message: `${acceptedFiles.length} file(s) selected. They will be uploaded after product is created.`, type: 'info' });
        }
    };

    const { getRootProps, getInputProps, isDragActive } = useDropzone({
        onDrop,
        accept: {
            'image/*': ['.jpeg', '.jpg', '.png', '.gif', '.webp'],
            'video/*': ['.mp4', '.mov', '.avi']
        },
        multiple: true
    });

    const uploadMediaFiles = async (files: File[], productIdToUse: number, variationId?: number | string | null, variationColor?: string | null) => {
        try {
            setUploadingMedia(true);
            const formData = new FormData();
            formData.append('product_id', productIdToUse.toString());
            
            // Handle variation_id - send null for general media, or variation ID for variation-specific media
            if (variationId !== null && variationId !== undefined && variationId !== '') {
                // For existing variations, use the ID; for new variations (temp-*), backend will handle after variation is saved
                if (typeof variationId === 'number' || (typeof variationId === 'string' && !variationId.toString().startsWith('temp-'))) {
                    formData.append('variation_id', variationId.toString());
                }
                // For temp variations, we'll link after variation is created (backend handles this)
            } else {
                // Explicitly set to null for general media (no variation)
                formData.append('variation_id', '');
            }
            
            // Determine color to use: from variation parameter, from variation object, or from mediaColor state
            let colorToUse = null;
            
            // Priority 1: Use color from variation parameter (passed directly)
            if (variationColor) {
                colorToUse = variationColor;
            } else if (variationId && variationId !== null && variationId !== '') {
                // Priority 2: Get color from variation object
                // Handle both numeric IDs and temp IDs
                let selectedVariation = null;
                
                    if (typeof variationId === 'string' && variationId.startsWith('temp-')) {
                    // Temp ID - find by index
                        const tempIndex = parseInt(variationId.split('-')[1]);
                    selectedVariation = variations[tempIndex];
                } else {
                    // Numeric ID - find by ID
                    selectedVariation = variations.find((v: any) => {
                        if (v.id && v.id.toString() === variationId.toString()) return true;
                    return false;
                });
                }
                
                if (selectedVariation && selectedVariation.color) {
                    colorToUse = selectedVariation.color;
                }
            }
            
            // Priority 3: Use manual mediaColor state (only if no variation is selected)
            if (!colorToUse && !variationId) {
                colorToUse = mediaColor || null;
            }
            
            // Send color if we have one (from variation or manual), or empty string for general media without color
            if (colorToUse) {
                formData.append('color', colorToUse);
            } else {
                formData.append('color', ''); // Empty string for general media without color
            }
            
            files.forEach((file) => {
                formData.append('files[]', file);
            });

            const response = await useProductStore.uploadMedia(formData);
            if (response.data?.status) {
                const uploadedMedia = response.data.data;
                // Format URLs to ensure they're properly displayed
                const formattedMedia = uploadedMedia.map((item: any) => ({
                    ...item,
                    url: item.url || (item.file_path ? `/storage/${item.file_path}` : null)
                }));
                // If no media exists yet, set first one as primary (only if not variation-specific)
                if (media.length === 0 && formattedMedia.length > 0 && !variationId) {
                    // First uploaded media is automatically set as primary by backend
                    // But we can ensure it's marked in our state
                    formattedMedia[0].is_primary = true;
                }
                setMedia((prevMedia) => [...prevMedia, ...formattedMedia]);
                setMediaColor('');
                setSelectedVariationForMedia(null);
                toast({ message: 'Media uploaded successfully', type: 'success' });
            }
        } catch (error: any) {
            console.error('Error uploading media:', error);
            toast({ message: error.response?.data?.message || 'Failed to upload media', type: 'error' });
        } finally {
            setUploadingMedia(false);
        }
    };

    const uploadPendingMedia = async (savedProductId: number) => {
        if (pendingMediaFiles.length > 0 && savedProductId) {
            const formData = new FormData();
            formData.append('product_id', savedProductId.toString());
            if (mediaColor) {
                formData.append('color', mediaColor);
            }
            // Note: variation_id will be set after variations are created
            // For now, upload as general media
            
            pendingMediaFiles.forEach((file) => {
                formData.append('files[]', file);
            });

            const response = await useProductStore.uploadMedia(formData);
            if (response.data?.status) {
                const uploadedMedia = response.data.data;
                // Update media state with uploaded media - ensure URLs are properly formatted
                if (uploadedMedia && uploadedMedia.length > 0) {
                    const formattedMedia = uploadedMedia.map((item: any) => ({
                        ...item,
                        url: item.url || (item.file_path ? `/storage/${item.file_path}` : null)
                    }));
                    setMedia((prevMedia) => [...prevMedia, ...formattedMedia]);
                }
                // Clear pending files after successful upload
                setPendingMediaFiles([]);
                setPendingImages([]);
                setPendingVideos([]);
                setMediaColor('');
                setSelectedVariationForMedia(null);
                return true;
            }
            throw new Error('Failed to upload media');
        }
        return true;
    };

    const removePendingFile = (file: File, type: 'image' | 'video') => {
        if (type === 'image') {
            setPendingImages(pendingImages.filter(f => f !== file));
        } else {
            setPendingVideos(pendingVideos.filter(f => f !== file));
        }
        setPendingMediaFiles(pendingMediaFiles.filter(f => f !== file));
    };

    const removePendingVariationFile = (variationIndex: number, file: File) => {
        setPendingVariationMedia(prev => ({
            ...prev,
            [variationIndex]: (prev[variationIndex] || []).filter(f => f !== file)
        }));
    };

    const handleVariationMediaDrop = async (acceptedFiles: File[], variationIndex: number, variation: any) => {
        if (acceptedFiles.length === 0) return;

        const currentProductId = productId || (product?.id);
        
        if (currentProductId) {
            // Upload immediately if product exists
            setUploadingVariationMedia(prev => ({ ...prev, [variationIndex]: true }));
            try {
                // Use the current variation from the variations array (which should have the latest ID after update)
                const currentVariation = variations[variationIndex];
                const variationIdToUse = currentVariation?.id || variation.id || null;
                
                await uploadMediaFiles(acceptedFiles, currentProductId, variationIdToUse || `temp-${variationIndex}`, variation.color || currentVariation?.color);
            } catch (error: any) {
                console.error('Error uploading variation media:', error);
                toast({ 
                    message: error.response?.data?.message || 'Failed to upload media. Please try again.', 
                    type: 'error' 
                });
            } finally {
                setUploadingVariationMedia(prev => ({ ...prev, [variationIndex]: false }));
            }
        } else {
            // Store files for later upload after product creation
            setPendingVariationMedia(prev => ({
                ...prev,
                [variationIndex]: [...(prev[variationIndex] || []), ...acceptedFiles]
            }));
            toast({ message: `${acceptedFiles.length} file(s) selected. They will be uploaded after product is created.`, type: 'info' });
        }
    };

    const handleUpdateMediaColor = async (mediaId: number, color: string) => {
        try {
            const response = await useProductStore.updateMedia({ id: mediaId, color });
            if (response.data?.status) {
                setMedia(media.map((m: any) => m.id === mediaId ? { ...m, color } : m));
                toast({ message: 'Media color updated successfully', type: 'success' });
            }
        } catch (error: any) {
            console.error('Error updating media color:', error);
            toast({ message: 'Failed to update media color', type: 'error' });
        }
    };

    const handleSetPrimaryMedia = async (mediaId: number) => {
        try {
            const response = await useProductStore.updateMedia({ id: mediaId, is_primary: true });
            if (response.data?.status) {
                // Update local state: set the selected one as primary, others as not primary
                setMedia(media.map((m: any) => ({
                    ...m,
                    is_primary: m.id === mediaId ? true : false
                })));
                toast({ message: 'Primary media updated successfully', type: 'success' });
            }
        } catch (error: any) {
            console.error('Error setting primary media:', error);
            toast({ message: 'Failed to set primary media', type: 'error' });
        }
    };

    const handleDeleteMedia = async (mediaId: number) => {
        setShowDeleteMediaConfirm(true);
        setMediaToDelete(mediaId);

        try {
            const response = await useProductStore.deleteMedia({ id: mediaId });
            if (response.data?.status) {
                setMedia(media.filter((m: any) => m.id !== mediaId));
                toast({ message: 'Media deleted successfully', type: 'success' });
            }
        } catch (error: any) {
            console.error('Error deleting media:', error);
            toast({ message: 'Failed to delete media', type: 'error' });
        }
    };

    // Render media item component
    const renderMediaItem = (item: any, showColorPicker: boolean = true) => {
        return (
            <>
                <div className="relative group mb-2">
                    {item.type === 'image' ? (
                        <div className="relative">
                            <img
                                src={item.url || (item.file_path ? `/storage/${item.file_path}` : '/placeholder-image.png')}
                                alt={item.file_name || 'Product image'}
                                className="w-full h-32 object-cover rounded-md border border-gray-200"
                                onError={(e) => {
                                    (e.target as HTMLImageElement).src = '/placeholder-image.png';
                                }}
                            />
                            <div className="absolute top-2 left-2 px-2 py-1 bg-white bg-opacity-80 rounded flex items-center space-x-1">
                                <PhotoIcon className="h-3 w-3 text-gray-700" />
                                <span className="text-xs text-gray-700">Image</span>
                            </div>
                        </div>
                    ) : (
                        <div className="relative">
                            <video
                                src={item.url || (item.file_path ? `/storage/${item.file_path}` : '')}
                                className="w-full h-32 object-cover rounded-md border border-gray-200"
                                controls
                            />
                            <div className="absolute top-2 left-2 px-2 py-1 bg-white bg-opacity-80 rounded flex items-center space-x-1">
                                <VideoCameraIcon className="h-3 w-3 text-gray-700" />
                                <span className="text-xs text-gray-700">Video</span>
                            </div>
                        </div>
                    )}
                    {item.is_primary && (
                        <span className="absolute top-2 left-2 px-2 py-1 text-xs font-medium bg-indigo-600 text-white rounded z-10">
                            Primary
                        </span>
                    )}
                    <div className="absolute bottom-2 left-2 right-2 flex justify-between items-center opacity-0 group-hover:opacity-100 transition-opacity z-10">
                        <button
                            type="button"
                            onClick={() => handleSetPrimaryMedia(item.id)}
                            className={`px-2 py-1 text-xs font-medium rounded ${
                                item.is_primary
                                    ? 'bg-indigo-600 text-white'
                                    : 'bg-white text-gray-700 hover:bg-gray-100 shadow'
                            }`}
                            title="Set as Primary"
                        >
                            {item.is_primary ? 'Primary' : 'Set Primary'}
                        </button>
                    </div>
                    <button
                        type="button"
                        onClick={() => handleDeleteMedia(item.id)}
                        className="absolute top-2 right-2 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity z-10"
                    >
                        <TrashIcon className="h-4 w-4" />
                    </button>
                </div>
                {showColorPicker && (
                    <div>
                        <label className="block text-xs font-medium text-gray-700 mb-1">
                            Color: {item.color || 'Not set'}
                        </label>
                        {item.color && (
                            <div
                                className="w-full h-6 rounded border border-gray-300"
                                style={{ backgroundColor: item.color }}
                            />
                        )}
                    </div>
                )}
            </>
        );
    };

    const handleAddVariation = () => {
        // Add a single empty variation (check for duplicates)
            const newVariation = {
                id: null,
                size: '',
                color: '',
            gender: isFashionCategory() ? 'male' : null,
                stock_quantity: 0,
                in_stock: true,
            };
            
            // Check if this exact combination already exists
        const newSize = newVariation.size || '';
        const newColor = newVariation.color || '';
        const newGender = newVariation.gender || '';
        
        if (isDuplicateVariation(newSize, newColor, newGender)) {
            const duplicateMsg = newGender 
                ? `This variation combination (Size: ${newSize || 'empty'}, Color: ${newColor || 'empty'}, Gender: ${newGender}) already exists. Duplicate variations are not allowed.`
                : `This variation combination (Size: ${newSize || 'empty'}, Color: ${newColor || 'empty'}) already exists. Duplicate variations are not allowed.`;
            toast({ message: duplicateMsg, type: 'warning' });
                return;
            }
            
            const updated = [...variations, newVariation];
            setVariations(updated);
            
            // Auto-calculate total stock from variations
            const totalStock = updated.reduce((sum, v) => {
                return sum + (parseInt(v.stock_quantity) || 0);
            }, 0);
            setFormData(prev => ({
                ...prev,
                total_quantity: totalStock.toString()
            }));
    };

    const handleRemoveVariation = (index: number) => {
        const updated = variations.filter((_, i) => i !== index);
        setVariations(updated);
        
        // Recalculate total stock after removal
        if (updated.length > 0) {
            const totalStock = updated.reduce((sum, v) => {
                return sum + (parseInt(v.stock_quantity) || 0);
            }, 0);
            setFormData(prev => ({
                ...prev,
                total_quantity: totalStock.toString()
            }));
        } else {
            // If no variations, allow manual input
            setFormData(prev => ({
                ...prev,
                total_quantity: prev.total_quantity || '0'
            }));
        }
    };

    const handleVariationChange = (index: number, field: string, value: any) => {
        const updated = [...variations];
        const currentVariation = updated[index];
        const newVariation = { ...currentVariation, [field]: value };
        
        // Check for duplicates when changing size, color, or gender
        if (field === 'size' || field === 'color' || field === 'gender') {
            const newSize = field === 'size' ? value : (currentVariation.size || '');
            const newColor = field === 'color' ? value : (currentVariation.color || '');
            const newGender = field === 'gender' ? value : (currentVariation.gender || '');
            
            // Check if this combination already exists (excluding current index)
            if (isDuplicateVariation(newSize, newColor, newGender, index)) {
                const duplicateMsg = newGender 
                    ? `This variation combination (Size: ${newSize || 'empty'}, Color: ${newColor || 'empty'}, Gender: ${newGender}) already exists. Duplicate variations are not allowed.`
                    : `This variation combination (Size: ${newSize || 'empty'}, Color: ${newColor || 'empty'}) already exists. Duplicate variations are not allowed.`;
                toast({ message: duplicateMsg, type: 'warning' });
                return; // Don't update if duplicate
            }
        }
        
        updated[index] = newVariation;
        setVariations(updated);
        
        // Auto-calculate total stock from variations if they exist
        if (updated.length > 0) {
            const totalStock = updated.reduce((sum, v) => {
                return sum + (parseInt(v.stock_quantity) || 0);
            }, 0);
            setFormData(prev => ({
                ...prev,
                total_quantity: totalStock.toString()
            }));
        }
    };

    const handleColorChange = (color: any) => {
        setMediaColor(color.hex);
    };

    const handleVariationColorChange = (index: number, color: any) => {
        setVariationColors({ ...variationColors, [index]: color.hex });
        handleVariationChange(index, 'color', color.hex);
        setVariationColorPickers({ ...variationColorPickers, [index]: false });
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setSubmitting(true);
        setErrors({});

        // Validate for duplicate variations before submitting
        const duplicateVariations: number[] = [];
        variations.forEach((v: any, index: number) => {
            const size = (v.size || '').trim();
            const color = (v.color || '').trim();
            const gender = (v.gender || '').trim();
            
            // Check if this variation is a duplicate (excluding itself)
            if (isDuplicateVariation(size, color, gender, index)) {
                duplicateVariations.push(index + 1); // +1 for user-friendly numbering
            }
        });

        if (duplicateVariations.length > 0) {
            setSubmitting(false);
            toast({ 
                message: `Duplicate variations found at position(s) ${duplicateVariations.join(', ')}. Please remove duplicates before saving.`, 
                type: 'error' 
            });
            return;
        }

        try {
                const submitData: any = {
                ...formData,
                price: parseFloat(formData.price),
                category: parseInt(formData.category),
                total_quantity: parseInt(formData.total_quantity),
                is_approve: formData.is_approve,
                is_returnable: formData.is_returnable !== undefined ? formData.is_returnable : false,
                is_replaceable: formData.is_replaceable !== undefined ? formData.is_replaceable : false,
                return_policy_note: formData.return_policy_note || null,
                variations: variations.map((v: any) => ({
                    size: v.size || null,
                    color: v.color || null,
                    gender: v.gender || null,
                    stock_quantity: parseInt(v.stock_quantity) || 0,
                    in_stock: v.in_stock !== false,
                })),
            };

            if (isEditMode) {
                submitData.id = productId;
            }

            const response = isEditMode 
                ? await useProductStore.update(submitData)
                : await useProductStore.store(submitData);

            if (response.data?.status) {
                const savedProductId = response.data.data.id || productId;
                const savedVariations = response.data.data.variations || variations;
                
                // Upload pending media files if any (for new products)
                if (!isEditMode && savedProductId && pendingMediaFiles.length > 0) {
                    try {
                        setUploadingMedia(true);
                        await uploadPendingMedia(savedProductId);
                    } catch (error: any) {
                        console.error('Error uploading pending media:', error);
                        toast({ message: error.response?.data?.message || 'Product created but some media failed to upload.', type: 'warning' });
                    } finally {
                        setUploadingMedia(false);
                    }
                }
                
                // Upload pending variation media files if any (for both create and edit mode)
                if (savedProductId && savedVariations && Object.keys(pendingVariationMedia).length > 0) {
                    try {
                        // Upload media for each variation that has pending files
                        for (const [variationIndex, files] of Object.entries(pendingVariationMedia)) {
                            if (files.length > 0) {
                                const index = parseInt(variationIndex);
                                // Use saved variations if available, otherwise use current variations
                                const variation = savedVariations[index] || variations[index];
                                if (variation && variation.id) {
                                    setUploadingVariationMedia(prev => ({ ...prev, [index]: true }));
                                    try {
                                        await uploadMediaFiles(files, savedProductId, variation.id, variation.color);
                                        // Clear pending files for this variation after successful upload
                                        setPendingVariationMedia(prev => {
                                            const updated = { ...prev };
                                            delete updated[index];
                                            return updated;
                                        });
                                    } catch (error: any) {
                                        console.error(`Error uploading media for variation ${index}:`, error);
                                        toast({ message: `Failed to upload media for variation ${index + 1}`, type: 'warning' });
                                    } finally {
                                        setUploadingVariationMedia(prev => ({ ...prev, [index]: false }));
                                    }
                                }
                            }
                        }
                    } catch (error: any) {
                        console.error('Error uploading pending variation media:', error);
                        toast({ message: isEditMode ? 'Product updated but some variation media failed to upload.' : 'Product created but some variation media failed to upload.', type: 'warning' });
                    }
                }
                
                // Reload product data in edit mode to get updated variations and media
                // IMPORTANT: Media is managed separately and should NOT be cleared during product update
                if (isEditMode && savedProductId) {
                    // Store current media as backup before reload to prevent data loss
                    const currentMediaBackup = [...media];
                    const currentMediaCount = currentMediaBackup.length;
                    
                    try {
                        const reloadResponse = await useProductStore.show({ id: savedProductId });
                        if (reloadResponse.data?.status && reloadResponse.data?.data) {
                            const reloadedProduct = reloadResponse.data.data;
                            setProduct(reloadedProduct);
                            
                            // Preserve existing media and merge with reloaded media
                            // Format URLs to ensure they're properly displayed
                            const reloadedMedia = (reloadedProduct.media || []).map((item: any) => ({
                                ...item,
                                url: item.url || (item.file_path ? `/storage/${item.file_path}` : null)
                            }));
                            
                            // CRITICAL: Never clear media if we had media before and reload returns empty
                            // This prevents accidental deletion of media during updates
                            if (reloadedMedia.length === 0 && currentMediaCount > 0) {
                                console.warn('No media returned from reload, preserving existing media to prevent data loss');
                                // Keep existing media unchanged - don't update the state
                                // This ensures media is never accidentally cleared
                            } else if (reloadedMedia.length > 0) {
                                // We have reloaded media - merge intelligently
                                const existingMediaIds = new Set(currentMediaBackup.map((m: any) => m.id).filter((id: any) => id != null));
                                const reloadedMediaIds = new Set(reloadedMedia.map((m: any) => m.id).filter((id: any) => id != null));
                                
                                // Check if we're losing any media
                                const missingMedia = currentMediaBackup.filter((m: any) => {
                                    const mediaId = m.id;
                                    return mediaId != null && !reloadedMediaIds.has(mediaId);
                                });
                                
                                if (missingMedia.length > 0) {
                                    // Some media is missing - merge to preserve it
                                    const finalMedia = [...reloadedMedia, ...missingMedia];
                                    setMedia(finalMedia);
                                    console.warn(`Preserved ${missingMedia.length} media items that were missing from reload`);
                                } else if (reloadedMedia.length >= currentMediaCount) {
                                    // Reloaded media has same or more items - use it
                                    setMedia(reloadedMedia);
                } else {
                                    // Reloaded has fewer items - preserve existing to be safe
                                    console.warn(`Reloaded media (${reloadedMedia.length}) has fewer items than existing (${currentMediaCount}), preserving existing`);
                                    // Keep existing media unchanged
                                }
                            } else {
                                // No reloaded media and no existing media - only set empty if we truly had none
                                if (currentMediaCount === 0) {
                                    setMedia([]);
                                } else {
                                    // We had media but reload returned none - preserve existing
                                    console.warn('Had existing media but reload returned none, preserving existing media');
                                    // Keep existing media unchanged
                                }
                            }
                            
                            // Update variations with fresh data (including new IDs after recreation)
                            const reloadedVariations = reloadedProduct.variations || [];
                            setVariations(reloadedVariations);
                            
                            // Ensure product state is updated so product.id is available for media uploads
                            // This is important for upload-media to work after product update
                        } else {
                            // If reload response is invalid but we have backup media, keep it
                            if (currentMediaCount > 0) {
                                console.warn('Reload response invalid, preserving existing media to prevent data loss');
                                // Don't update media state, keep existing - media is preserved
                            }
                        }
                    } catch (error) {
                        console.error('Error reloading product data:', error);
                        // CRITICAL: Never clear existing media if reload fails
                        if (currentMediaCount > 0) {
                            // Keep existing media state unchanged - media is preserved
                            console.warn('Reload failed, preserving existing media state to prevent data loss');
                        }
                        toast({ message: 'Product updated successfully. Your existing media is preserved.', type: 'success' });
                    }
                }
                
                if (!isEditMode && (pendingMediaFiles.length > 0 || Object.keys(pendingVariationMedia).length > 0)) {
                    toast({ message: 'Product created and media uploaded successfully.', type: 'success' });
                // Wait a bit longer to ensure media upload completes before redirect
                setTimeout(() => {
                        router.visit('/admin/products');
                    }, 1000);
                } else if (isEditMode) {
                    toast({ message: 'Product updated successfully', type: 'success' });
                    // Redirect to listing page after update
                    setTimeout(() => {
                    router.visit('/admin/products');
                }, 1000);
                } else {
                    toast({ message: 'Product created successfully.', type: 'success' });
                    // Wait a bit longer to ensure media upload completes before redirect
                    setTimeout(() => {
                        router.visit('/admin/products');
                    }, 1000);
                }
            } else {
                if (response.data?.errors) {
                    setErrors(response.data.errors);
                } else if (response.data?.message) {
                    setErrors({ general: response.data.message });
                }
            }
        } catch (error: any) {
            console.error('Error saving product:', error);
            if (error.response?.data?.errors) {
                setErrors(error.response.data.errors);
            } else if (error.response?.data?.message) {
                setErrors({ general: error.response.data.message });
            } else {
                setErrors({ general: 'An error occurred while saving the product' });
            }
        } finally {
            setSubmitting(false);
        }
    };

    if (isEditMode && loading) {
        return (
            <AdminLayout currentPath="/admin/products">
                <div className="flex items-center justify-center h-64">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                </div>
            </AdminLayout>
        );
    }

    return (
        <AdminLayout currentPath="/admin/products">
            <div className="space-y-6">
                {/* Back Button */}
                <div>
                    <button
                        onClick={() => router.visit('/admin/products')}
                        className="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 hover:text-gray-900 transition-colors"
                    >
                        <ArrowLeftIcon className="h-5 w-5 mr-2" />
                        Back to Products
                    </button>
                </div>

                {/* Header */}
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        {isEditMode ? 'Edit Product' : 'Add New Product'}
                    </h1>
                    <p className="mt-2 text-sm text-gray-600">
                        {isEditMode ? 'Update product information' : 'Create a new product for your catalog'}
                    </p>
                </div>

                {/* Form */}
                <div className="bg-white shadow rounded-lg">
                    <form onSubmit={handleSubmit} className="p-6">
                        {errors.general && (
                            <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-md">
                                <p className="text-sm text-red-600">{errors.general}</p>
                            </div>
                        )}

                        <div className="space-y-6">
                            {/* Product Name */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Product Name <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="text"
                                    name="product_name"
                                    value={formData.product_name}
                                    onChange={handleInputChange}
                                    required
                                    className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                                        errors.product_name ? 'border-red-300' : 'border-gray-300'
                                    }`}
                                    placeholder="Enter product name"
                                />
                                {errors.product_name && (
                                    <p className="mt-1 text-sm text-red-600">{errors.product_name}</p>
                                )}
                            </div>

                            {/* Description */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Description <span className="text-red-500">*</span>
                                </label>
                                <textarea
                                    name="description"
                                    value={formData.description}
                                    onChange={handleInputChange}
                                    required
                                    rows={6}
                                    className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                                        errors.description ? 'border-red-300' : 'border-gray-300'
                                    }`}
                                    placeholder="Enter product description"
                                />
                                {errors.description && (
                                    <p className="mt-1 text-sm text-red-600">{errors.description}</p>
                                )}
                            </div>

                            {/* Category and Price Row */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Category - Cascading Dropdowns */}
                                <div className="space-y-3">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Category <span className="text-red-500">*</span>
                                    </label>
                                    
                                    {/* Main Category */}
                                    <div>
                                        <label className="block text-xs font-medium text-gray-600 mb-1">
                                            Main Category
                                    </label>
                                    <select
                                            name="main_category"
                                            value={selectedMainCategory}
                                        onChange={handleInputChange}
                                            required={!selectedMainCategory}
                                            className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm ${
                                            errors.category ? 'border-red-300' : 'border-gray-300'
                                        }`}
                                            disabled={categories.length === 0}
                                    >
                                            <option value="">Select main category</option>
                                            {categories
                                                .filter((cat: any) => !cat.parent_id)
                                                .sort((a: any, b: any) => {
                                                    if (a.sort_order !== b.sort_order) {
                                                        return (a.sort_order || 0) - (b.sort_order || 0);
                                                    }
                                                    return (a.name || '').localeCompare(b.name || '');
                                                })
                                                .map((category: any) => (
                                            <option key={category.id} value={category.id}>
                                                {category.name}
                                            </option>
                                        ))}
                                    </select>
                                    </div>
                                    
                                    {/* Sub Category */}
                                    {selectedMainCategory && (
                                        <div>
                                            <label className="block text-xs font-medium text-gray-600 mb-1">
                                                Sub Category
                                            </label>
                                            <select
                                                name="sub_category"
                                                value={selectedSubCategory}
                                                onChange={handleInputChange}
                                                className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm ${
                                                    errors.category ? 'border-red-300' : 'border-gray-300'
                                                }`}
                                            >
                                                <option value="">Select sub category (optional)</option>
                                                {categories
                                                    .filter((cat: any) => cat.parent_id === parseInt(selectedMainCategory))
                                                    .sort((a: any, b: any) => {
                                                        if (a.sort_order !== b.sort_order) {
                                                            return (a.sort_order || 0) - (b.sort_order || 0);
                                                        }
                                                        return (a.name || '').localeCompare(b.name || '');
                                                    })
                                                    .map((category: any) => (
                                                        <option key={category.id} value={category.id}>
                                                            {category.name}
                                                        </option>
                                                    ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* Sub-Sub Category */}
                                    {selectedSubCategory && (
                                        <div>
                                            <label className="block text-xs font-medium text-gray-600 mb-1">
                                                Sub-Sub Category
                                            </label>
                                            <select
                                                name="sub_sub_category"
                                                value={selectedSubSubCategory}
                                                onChange={handleInputChange}
                                                className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm ${
                                                    errors.category ? 'border-red-300' : 'border-gray-300'
                                                }`}
                                            >
                                                <option value="">Select sub-sub category (optional)</option>
                                                {categories
                                                    .filter((cat: any) => cat.parent_id === parseInt(selectedSubCategory))
                                                    .sort((a: any, b: any) => {
                                                        if (a.sort_order !== b.sort_order) {
                                                            return (a.sort_order || 0) - (b.sort_order || 0);
                                                        }
                                                        return (a.name || '').localeCompare(b.name || '');
                                                    })
                                                    .map((category: any) => (
                                                        <option key={category.id} value={category.id}>
                                                            {category.name}
                                                        </option>
                                                    ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* Hidden input for final category selection */}
                                    <input type="hidden" name="category" value={formData.category} />
                                    
                                    {errors.category && (
                                        <p className="mt-1 text-sm text-red-600">{errors.category}</p>
                                    )}
                                    
                                    {formData.category && (
                                        <p className="mt-1 text-xs text-gray-500">
                                            Selected: {categories.find((c: any) => c.id === parseInt(formData.category))?.name || 'Unknown'}
                                        </p>
                                    )}
                                    
                                    {categories.length === 0 && (
                                        <p className="mt-1 text-xs text-yellow-600">
                                            No categories found. Please create categories first.
                                        </p>
                                    )}
                                </div>

                                {/* Price */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Price <span className="text-red-500">*</span>
                                    </label>
                                    <input
                                        type="number"
                                        name="price"
                                        value={formData.price}
                                        onChange={handleInputChange}
                                        required
                                        min="0"
                                        step="0.01"
                                        className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                                            errors.price ? 'border-red-300' : 'border-gray-300'
                                        }`}
                                        placeholder="0.00"
                                    />
                                    {errors.price && (
                                        <p className="mt-1 text-sm text-red-600">{errors.price}</p>
                                    )}
                                </div>
                            </div>

                            {/* Approval Status */}
                            <div>
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        name="is_approve"
                                        id="is_approve"
                                        checked={formData.is_approve === 1}
                                        onChange={handleInputChange}
                                        className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                    />
                                    <label htmlFor="is_approve" className="ml-2 block text-sm text-gray-900">
                                        Approve Product
                                    </label>
                                </div>
                            </div>

                            {/* Return/Refund Settings */}
                            <div className="border-t pt-6">
                                <h3 className="text-lg font-semibold text-gray-900 mb-4">Return/Refund Settings</h3>
                                
                                <div className="space-y-4">
                                    {/* Is Returnable */}
                                    <div>
                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                name="is_returnable"
                                                id="is_returnable"
                                                checked={formData.is_returnable === true}
                                                onChange={(e) => setFormData({ ...formData, is_returnable: e.target.checked })}
                                                className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                            />
                                            <label htmlFor="is_returnable" className="ml-2 block text-sm text-gray-900">
                                                Product is Returnable & Refundable
                                            </label>
                                        </div>
                                        <p className="mt-1 text-xs text-gray-500">
                                            Uncheck if this product cannot be returned or refunded
                                        </p>
                                    </div>

                                    {/* Is Replaceable */}
                                    <div>
                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                name="is_replaceable"
                                                id="is_replaceable"
                                                checked={formData.is_replaceable === true}
                                                onChange={(e) => setFormData({ ...formData, is_replaceable: e.target.checked })}
                                                className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                            />
                                            <label htmlFor="is_replaceable" className="ml-2 block text-sm text-gray-900">
                                                Product is Replaceable
                                            </label>
                                        </div>
                                        <p className="mt-1 text-xs text-gray-500">
                                            Uncheck if this product cannot be replaced (only return/refund allowed)
                                        </p>
                                    </div>

                                    {/* Return Policy Note */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Return Policy Note (Optional)
                                        </label>
                                        <textarea
                                            name="return_policy_note"
                                            value={formData.return_policy_note}
                                            onChange={handleInputChange}
                                            rows={3}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                            placeholder="e.g., Returnable within 7 days, items must be unused and in original packaging..."
                                        />
                                        <p className="mt-1 text-xs text-gray-500">
                                            This note will be displayed to customers on the product page
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Product Media & Variations Tabs */}
                            <div className="border-t pt-6">
                                {/* Tab Navigation */}
                                <div className="border-b border-gray-200 mb-6">
                                    <nav className="flex space-x-8">
                                        <button
                                            type="button"
                                            onClick={() => setActiveMainTab('media')}
                                            className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                                activeMainTab === 'media'
                                                    ? 'border-indigo-500 text-indigo-600'
                                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                            }`}
                                        >
                                            Product Media
                                            <span className="ml-2 text-xs bg-gray-100 px-2 py-0.5 rounded">
                                                {media.filter((m: any) => !m.variation_id).length}
                                            </span>
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setActiveMainTab('variations')}
                                            className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                                activeMainTab === 'variations'
                                                    ? 'border-indigo-500 text-indigo-600'
                                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                            }`}
                                        >
                                            Product Variations
                                            <span className="ml-2 text-xs bg-gray-100 px-2 py-0.5 rounded">
                                                {variations.length}
                                            </span>
                                        </button>
                                    </nav>
                                </div>

                                {/* Tab Content: Product Media */}
                                {activeMainTab === 'media' && (
                                    <div>
                                        <div className="mb-4">
                                            <h3 className="text-lg font-medium text-gray-900">Product Media</h3>
                                            <p className="text-sm text-gray-500 mt-1">
                                                General product media (not linked to any variation). Optional color can be assigned.
                                            </p>
                                        </div>
                                        
                                        {/* Ensure no variation is selected for general media */}
                                        {selectedVariationForMedia !== null && (
                                            <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                                                <p className="text-sm text-yellow-800">
                                                    <strong>Warning:</strong> A variation is selected. This will upload variation-specific media.
                                                    <button
                                                        type="button"
                                                        onClick={() => setSelectedVariationForMedia(null)}
                                                        className="ml-2 text-yellow-900 underline"
                                                    >
                                                        Clear selection to upload general media
                                                    </button>
                                                </p>
                                            </div>
                                        )}
                                        
                                        {/* Media Upload Tabs */}
                                    <div className="mb-4">
                                        <div className="border-b border-gray-200">
                                            <nav className="flex space-x-8">
                                                <button
                                                    type="button"
                                                    onClick={() => setActiveMediaTab('images')}
                                                    className={`py-2 px-1 border-b-2 font-medium text-sm ${
                                                        activeMediaTab === 'images'
                                                            ? 'border-indigo-500 text-indigo-600'
                                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                                    }`}
                                                >
                                                    IMAGES
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => setActiveMediaTab('video')}
                                                    className={`py-2 px-1 border-b-2 font-medium text-sm ${
                                                        activeMediaTab === 'video'
                                                            ? 'border-indigo-500 text-indigo-600'
                                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                                    }`}
                                                >
                                                    VIDEO
                                                </button>
                                            </nav>
                                        </div>

                                        {/* Upload Area */}
                                        <div className="mt-4">
                                            <div
                                                {...getRootProps()}
                                                className={`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${
                                                    isDragActive
                                                        ? 'border-indigo-500 bg-indigo-50'
                                                        : 'border-gray-300 hover:border-indigo-400 hover:bg-gray-50'
                                                } ${uploadingMedia ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            >
                                                <input {...getInputProps()} disabled={uploadingMedia} />
                                                <div className="space-y-2">
                                                    {activeMediaTab === 'images' ? (
                                                        <PhotoIcon className="mx-auto h-12 w-12 text-gray-400" />
                                                    ) : (
                                                        <VideoCameraIcon className="mx-auto h-12 w-12 text-gray-400" />
                                                    )}
                                                    {isDragActive ? (
                                                        <p className="text-sm text-indigo-600 font-medium">Drop the files here...</p>
                                                    ) : (
                                                        <>
                                                            <p className="text-sm text-gray-600">
                                                                <span className="font-medium text-indigo-600">Click to upload</span> or drag and drop your {activeMediaTab === 'images' ? 'image' : 'video'} here
                                                            </p>
                                                            <p className="text-xs text-gray-500">
                                                                {activeMediaTab === 'images' 
                                                                    ? 'Images (JPEG, PNG, GIF, WEBP)'
                                                                    : 'Videos (MP4, MOV, AVI)'
                                                                }
                                                            </p>
                                                        </>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Pending Images Preview */}
                                            {activeMediaTab === 'images' && (pendingImages.length > 0 || media.filter((m: any) => m.type === 'image').length > 0) && (
                                                <div className="mt-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                                    {/* Pending Images */}
                                                    {pendingImages.map((file, index) => (
                                                        <div key={`pending-${index}`} className="relative group">
                                                            <img
                                                                src={URL.createObjectURL(file)}
                                                                alt={`Preview ${index}`}
                                                                className="w-full h-32 object-cover rounded-md border border-gray-200"
                                                            />
                                                            <button
                                                                type="button"
                                                                onClick={() => removePendingFile(file, 'image')}
                                                                className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                            >
                                                                <XMarkIcon className="h-4 w-4" />
                                                            </button>
                                                        </div>
                                                    ))}
                                                    {/* Uploaded Images */}
                                                    {media.filter((m: any) => m.type === 'image').map((item: any) => {
                                                        const imageUrl = item.url || (item.file_path ? `/storage/${item.file_path}` : null);
                                                        return (
                                                        <div key={item.id} className="relative group">
                                                            <img
                                                                src={imageUrl || '/placeholder-image.png'}
                                                                alt={item.file_name || 'Product image'}
                                                                className="w-full h-32 object-cover rounded-md border border-gray-200"
                                                                onError={(e) => {
                                                                    (e.target as HTMLImageElement).src = '/placeholder-image.png';
                                                                }}
                                                            />
                                                            {item.is_primary && (
                                                                <span className="absolute top-1 left-1 px-2 py-1 text-xs font-medium bg-indigo-600 text-white rounded">
                                                                    Primary
                                                                </span>
                                                            )}
                                                            <div className="absolute bottom-1 left-1 right-1 flex justify-between items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button
                                                                    type="button"
                                                                    onClick={() => handleSetPrimaryMedia(item.id)}
                                                                    className={`px-2 py-1 text-xs font-medium rounded ${
                                                                        item.is_primary
                                                                            ? 'bg-indigo-600 text-white'
                                                                            : 'bg-white text-gray-700 hover:bg-gray-100 shadow'
                                                                    }`}
                                                                    title="Set as Primary"
                                                                >
                                                                    {item.is_primary ? 'Primary' : 'Set Primary'}
                                                                </button>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={() => handleDeleteMedia(item.id)}
                                                                className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                            >
                                                                <XMarkIcon className="h-4 w-4" />
                                                            </button>
                                                        </div>
                                                        );
                                                    })}
                                                </div>
                                            )}

                                            {/* Pending Videos Preview */}
                                            {activeMediaTab === 'video' && (pendingVideos.length > 0 || media.filter((m: any) => m.type === 'video').length > 0) && (
                                                <div className="mt-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                                    {/* Pending Videos */}
                                                    {pendingVideos.map((file, index) => (
                                                        <div key={`pending-video-${index}`} className="relative group">
                                                            <video
                                                                src={URL.createObjectURL(file)}
                                                                className="w-full h-32 object-cover rounded-md border border-gray-200"
                                                                controls
                                                            />
                                                            <button
                                                                type="button"
                                                                onClick={() => removePendingFile(file, 'video')}
                                                                className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                            >
                                                                <XMarkIcon className="h-4 w-4" />
                                                            </button>
                                                        </div>
                                                    ))}
                                                    {/* Uploaded Videos */}
                                                    {media.filter((m: any) => m.type === 'video').map((item: any) => {
                                                        const videoUrl = item.url || (item.file_path ? `/storage/${item.file_path}` : '');
                                                        return (
                                                        <div key={item.id} className="relative group">
                                                            <video
                                                                src={videoUrl}
                                                                className="w-full h-32 object-cover rounded-md border border-gray-200"
                                                                controls
                                                            />
                                                            {item.is_primary && (
                                                                <span className="absolute top-1 left-1 px-2 py-1 text-xs font-medium bg-indigo-600 text-white rounded">
                                                                    Primary
                                                                </span>
                                                            )}
                                                            <div className="absolute bottom-1 left-1 right-1 flex justify-between items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button
                                                                    type="button"
                                                                    onClick={() => handleSetPrimaryMedia(item.id)}
                                                                    className={`px-2 py-1 text-xs font-medium rounded ${
                                                                        item.is_primary
                                                                            ? 'bg-indigo-600 text-white'
                                                                            : 'bg-white text-gray-700 hover:bg-gray-100'
                                                                    }`}
                                                                    title="Set as Primary"
                                                                >
                                                                    {item.is_primary ? 'Primary' : 'Set Primary'}
                                                                </button>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={() => handleDeleteMedia(item.id)}
                                                                className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                            >
                                                                <XMarkIcon className="h-4 w-4" />
                                                            </button>
                                                        </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Color Picker - Only show if no variation is selected */}
                                        {selectedVariationForMedia === null && (
                                        <div className="mt-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Available Colors
                                            </label>
                                            <div className="flex items-center space-x-2 flex-wrap gap-2 mb-3">
                                                {[
                                                    { name: 'Red', value: '#D0021B' },
                                                    { name: 'Orange', value: '#ff9900' },
                                                    { name: 'Blue', value: '#0000ff' },
                                                    { name: 'Purple', value: '#800080' },
                                                    { name: 'Pink', value: '#ff1493' },
                                                    { name: 'Yellow', value: '#ffff00' },
                                                    { name: 'Green', value: '#00ff00' },
                                                    { name: 'Skyblue', value: '#87CEEB' },
                                                    { name: 'Brown', value: '#8b4513' },
                                                    { name: 'Black', value: '#000000' },
                                                    { name: 'Gray', value: '#808080' },
                                                    { name: 'White', value: '#ffffff' },
                                                ].map((color) => (
                                                    <button
                                                        key={color.value}
                                                        type="button"
                                                        onClick={() => setMediaColor(color.value)}
                                                        className={`w-10 h-10 rounded-full border-2 transition-all ${
                                                            mediaColor === color.value
                                                                ? 'border-blue-500 ring-2 ring-blue-300'
                                                                : 'border-gray-300 hover:border-gray-400'
                                                        }`}
                                                        style={{ backgroundColor: color.value }}
                                                        title={color.name}
                                                    />
                                                ))}
                                                <button
                                                    type="button"
                                                    onClick={() => setShowColorPicker(!showColorPicker)}
                                                    className="w-10 h-10 rounded-full border-2 border-dashed border-gray-300 flex items-center justify-center hover:border-gray-400 transition-colors"
                                                    title="Custom Color"
                                                >
                                                    <PlusIcon className="h-5 w-5 text-gray-400" />
                                                </button>
                                            </div>
                                            {showColorPicker && (
                                                <div className="absolute z-10 mt-2">
                                                    <div className="fixed inset-0" onClick={() => setShowColorPicker(false)}></div>
                                                    <div className="relative">
                                                        <SketchPicker
                                                            color={mediaColor || '#ffffff'}
                                                            onChange={handleColorChange}
                                                            width="220px"
                                                        />
                                                    </div>
                                                </div>
                                            )}
                                            <div className="flex items-center space-x-2">
                                                <span className="text-sm text-gray-700">Selected Color:</span>
                                                {mediaColor ? (
                                                    <>
                                                        <div
                                                            className="w-5 h-5 rounded-full border border-gray-300"
                                                            style={{ backgroundColor: mediaColor }}
                                                        />
                                                        <span className="text-sm text-gray-700">
                                                            {[
                                                                { name: 'Red', value: '#D0021B' },
                                                                { name: 'Orange', value: '#ff9900' },
                                                                { name: 'Blue', value: '#0000ff' },
                                                                { name: 'Purple', value: '#800080' },
                                                                { name: 'Pink', value: '#ff1493' },
                                                                { name: 'Yellow', value: '#ffff00' },
                                                                { name: 'Green', value: '#00ff00' },
                                                                { name: 'Skyblue', value: '#87CEEB' },
                                                                { name: 'Brown', value: '#8b4513' },
                                                                { name: 'Black', value: '#000000' },
                                                                { name: 'Gray', value: '#808080' },
                                                                { name: 'White', value: '#ffffff' },
                                                            ].find(c => c.value === mediaColor)?.name || mediaColor}
                                                        </span>
                                                        <button
                                                            type="button"
                                                            onClick={() => setMediaColor('')}
                                                            className="text-xs text-red-600 hover:text-red-800 ml-2"
                                                        >
                                                            Clear
                                                        </button>
                                                    </>
                                                ) : (
                                                    <span className="text-sm text-gray-400">No color selected</span>
                                                )}
                                            </div>
                                        </div>
                                        )}
                                        {uploadingMedia && (
                                            <p className="text-sm text-gray-500">Uploading...</p>
                                        )}
                                    </div>

                                    {/* Media Gallery - General Product Media Only */}
                                    {media.filter((m: any) => !m.variation_id).length > 0 && (
                                        <div className="mt-6 border-t pt-6">
                                            <h4 className="text-sm font-medium text-gray-900 mb-4">General Product Media Gallery</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                                {media.filter((m: any) => !m.variation_id).map((item: any) => (
                                                    <div key={item.id} className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                                        {renderMediaItem(item)}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {media.filter((m: any) => !m.variation_id).length === 0 && (
                                        <div className="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                            <p className="text-sm text-gray-500 text-center">
                                                No general media uploaded yet. Use the upload area above to add general product media.
                                            </p>
                                        </div>
                                    )}
                                    </div>
                                )}

                                {/* Tab Content: Product Variations */}
                                {activeMainTab === 'variations' && (
                                    <div>
                                        <div className="mb-4">
                                            <div className="flex justify-between items-center mb-2">
                                                <h3 className="text-lg font-medium text-gray-900">Product Variations</h3>
                                                <button
                                                    type="button"
                                                    onClick={handleAddVariation}
                                                    className="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700"
                                                >
                                                    <PlusIcon className="h-4 w-4 mr-1" />
                                                    Add Variation
                                                </button>
                                            </div>
                                            <p className="text-sm text-gray-500">
                                                Manage product variations (size, color, gender). Each variation can have its own media.
                                                Media color is automatically set from the variation's color.
                                            </p>
                                        </div>

                                {variations.length > 0 ? (
                                    <div className="space-y-4">
                                        {/* Sort variations: by gender, then by size for better display */}
                                        {[...variations].map((v: any, originalIndex: number) => ({ ...v, _originalIndex: originalIndex }))
                                            .sort((a: any, b: any) => {
                                            // Sort by gender first (male, female)
                                            const genderOrder = { 'male': 1, 'female': 2 };
                                            const genderA = genderOrder[a.gender as keyof typeof genderOrder] || 4;
                                            const genderB = genderOrder[b.gender as keyof typeof genderOrder] || 4;
                                            if (genderA !== genderB) return genderA - genderB;
                                            
                                            // Then sort by size
                                            const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', 'XXL', 'XXXL'];
                                            const sizeA = sizeOrder.indexOf(a.size || '');
                                            const sizeB = sizeOrder.indexOf(b.size || '');
                                            return sizeA - sizeB;
                                            })
                                            .map((variation: any, sortedIndex: number) => {
                                                // Use original index from the variation object, not the sorted index
                                                const originalIndex = variation._originalIndex;
                                                return (
                                            <div key={`variation-${originalIndex}-${variation.id || sortedIndex}`} className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                <div className={`grid grid-cols-1 gap-4 ${isFashionCategory() ? 'md:grid-cols-5' : 'md:grid-cols-4'}`}>
                                                    {isFashionCategory() && (
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                                Gender
                                                            </label>
                                                            <select
                                                                value={variation.gender || ''}
                                                                onChange={(e) => handleVariationChange(originalIndex, 'gender', e.target.value)}
                                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                            >
                                                                <option value="">Select Gender</option>
                                                                <option value="male">Male</option>
                                                                <option value="female">Female</option>
                                                            </select>
                                                        </div>
                                                    )}
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                                            Size
                                                        </label>
                                                        <select
                                                            value={variation.size || ''}
                                                            onChange={(e) => handleVariationChange(originalIndex, 'size', e.target.value)}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                        >
                                                            <option value="">Select Size</option>
                                                            <option value="XS">XS - Extra Small</option>
                                                            <option value="S">S - Small</option>
                                                            <option value="M">M - Medium</option>
                                                            <option value="L">L - Large</option>
                                                            <option value="XL">XL - Extra Large</option>
                                                            <option value="XXL">XXL - Extra Extra Large</option>
                                                            <option value="XXXL">XXXL - Extra Extra Extra Large</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                                            Available Colors
                                                        </label>
                                                        <div className="flex items-center space-x-1 flex-wrap gap-1 mb-2">
                                                            {[
                                                                { name: 'Red', value: '#D0021B' },
                                                                { name: 'Orange', value: '#ff9900' },
                                                                { name: 'Blue', value: '#0000ff' },
                                                                { name: 'Purple', value: '#800080' },
                                                                { name: 'Pink', value: '#ff1493' },
                                                                { name: 'Yellow', value: '#ffff00' },
                                                                { name: 'Green', value: '#00ff00' },
                                                                { name: 'Skyblue', value: '#87CEEB' },
                                                                { name: 'Brown', value: '#8b4513' },
                                                                { name: 'Black', value: '#000000' },
                                                                { name: 'Gray', value: '#808080' },
                                                                { name: 'White', value: '#ffffff' },
                                                            ].map((color) => (
                                                                <button
                                                                    key={color.value}
                                                                    type="button"
                                                                    onClick={() => handleVariationChange(originalIndex, 'color', color.value)}
                                                                    className={`w-8 h-8 rounded-full border transition-all ${
                                                                        (variation.color || variationColors[originalIndex]) === color.value
                                                                            ? 'border-blue-500 ring-1 ring-blue-300'
                                                                            : 'border-gray-300 hover:border-gray-400'
                                                                    }`}
                                                                    style={{ backgroundColor: color.value }}
                                                                    title={color.name}
                                                                />
                                                            ))}
                                                            <button
                                                                type="button"
                                                                onClick={() => {
                                                                    const newState = { ...variationColorPickers };
                                                                    newState[originalIndex] = !newState[originalIndex];
                                                                    setVariationColorPickers(newState);
                                                                }}
                                                                className="w-8 h-8 rounded-full border border-dashed border-gray-300 flex items-center justify-center hover:border-gray-400 transition-colors"
                                                                title="Custom Color"
                                                            >
                                                                <PlusIcon className="h-4 w-4 text-gray-400" />
                                                            </button>
                                                        </div>
                                                        {variationColorPickers[originalIndex] && (
                                                            <div className="absolute z-10 mt-1">
                                                                <div className="fixed inset-0" onClick={() => {
                                                                    const newState = { ...variationColorPickers };
                                                                    newState[originalIndex] = false;
                                                                    setVariationColorPickers(newState);
                                                                }}></div>
                                                                <div className="relative">
                                                                    <SketchPicker
                                                                        color={variation.color || variationColors[originalIndex] || '#ffffff'}
                                                                        onChange={(color) => handleVariationColorChange(originalIndex, color)}
                                                                        width="220px"
                                                                    />
                                                                </div>
                                                            </div>
                                                        )}
                                                        <div className="flex items-center space-x-2">
                                                            <span className="text-sm text-gray-700">Selected Color:</span>
                                                            {(variation.color || variationColors[originalIndex]) ? (
                                                                <>
                                                                    <div
                                                                        className="w-5 h-5 rounded-full border border-gray-300"
                                                                        style={{ backgroundColor: variation.color || variationColors[originalIndex] }}
                                                                    />
                                                                    <span className="text-sm text-gray-700">
                                                                        {[
                                                                            { name: 'Red', value: '#D0021B' },
                                                                            { name: 'Orange', value: '#ff9900' },
                                                                            { name: 'Blue', value: '#0000ff' },
                                                                            { name: 'Purple', value: '#800080' },
                                                                            { name: 'Pink', value: '#ff1493' },
                                                                            { name: 'Yellow', value: '#ffff00' },
                                                                            { name: 'Green', value: '#00ff00' },
                                                                            { name: 'Skyblue', value: '#87CEEB' },
                                                                            { name: 'Brown', value: '#8b4513' },
                                                                            { name: 'Black', value: '#000000' },
                                                                            { name: 'Gray', value: '#808080' },
                                                                            { name: 'White', value: '#ffffff' },
                                                                        ].find(c => c.value === (variation.color || variationColors[originalIndex]))?.name || (variation.color || variationColors[originalIndex])}
                                                                    </span>
                                                                </>
                                                            ) : (
                                                                <span className="text-sm text-gray-400">No color selected</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                                            Stock Quantity
                                                        </label>
                                                        <input
                                                            type="number"
                                                            value={variation.stock_quantity || 0}
                                                            onChange={(e) => handleVariationChange(originalIndex, 'stock_quantity', parseInt(e.target.value) || 0)}
                                                            min="0"
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                        />
                                                    </div>
                                                    <div className="flex items-end">
                                                        <div className="flex items-center space-x-4 w-full">
                                                            <div className="flex items-center">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={variation.in_stock !== false}
                                                                    onChange={(e) => handleVariationChange(originalIndex, 'in_stock', e.target.checked)}
                                                                    className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                                                />
                                                                <label className="ml-2 block text-sm text-gray-900">
                                                                    In Stock
                                                                </label>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={() => handleRemoveVariation(originalIndex)}
                                                                className="text-red-600 hover:text-red-800"
                                                            >
                                                                <TrashIcon className="h-5 w-5" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Variation-Specific Media Management */}
                                                <div className="mt-4 border-t pt-4">
                                                    <div className="flex items-center justify-between mb-3">
                                                        <h5 className="text-sm font-semibold text-gray-800">
                                                            Variation Media
                                                            {variation.color && (
                                                                <span className="ml-2 text-xs font-normal text-gray-500">
                                                                    (Color: {variation.color})
                                                                </span>
                                                            )}
                                                        </h5>
                                                    </div>
                                                    
                                                    {/* Variation Dropzone Component */}
                                                    {(() => {
                                                        const VariationDropzone = () => {
                                                            const { getRootProps, getInputProps, isDragActive } = useDropzone({
                                                                onDrop: (acceptedFiles) => handleVariationMediaDrop(acceptedFiles, originalIndex, variation),
                                                                accept: {
                                                                    'image/*': ['.jpeg', '.jpg', '.png', '.gif', '.webp'],
                                                                    'video/*': ['.mp4', '.mov', '.avi']
                                                                },
                                                                multiple: true,
                                                                disabled: uploadingVariationMedia[originalIndex] || false
                                                            });

                                                            const variationMedia = media.filter((m: any) => {
                                                                // Skip media without variation_id (general product media)
                                                                if (!m.variation_id) {
                                                                    return false;
                                                                }
                                                                
                                                                // Handle both string and number comparisons for variation_id
                                                                const mediaVariationId = m.variation_id;
                                                                const variationId = variation.id;
                                                                
                                                                // If variation has an ID, match it with media's variation_id (handle both string and number)
                                                                if (variationId) {
                                                                    // Convert both to strings for comparison to handle type mismatches
                                                                    return String(mediaVariationId) === String(variationId);
                                                                }
                                                                
                                                                // If variation doesn't have an ID yet (new variation), check for temp ID
                                                                return String(mediaVariationId) === `temp-${originalIndex}`;
                                                            });
                                                            const pendingFiles = pendingVariationMedia[originalIndex] || [];
                                                            const hasMedia = variationMedia.length > 0 || pendingFiles.length > 0;

                                                            return (
                                                                <>
                                                                    {/* Drag and Drop Area */}
                                                                    <div
                                                                        {...getRootProps()}
                                                                        className={`border-2 border-dashed rounded-lg p-4 text-center cursor-pointer transition-colors mb-3 ${
                                                                            isDragActive
                                                                                ? 'border-indigo-500 bg-indigo-50'
                                                                                : 'border-gray-300 hover:border-indigo-400 hover:bg-gray-50'
                                                                        } ${uploadingVariationMedia[originalIndex] ? 'opacity-50 cursor-not-allowed' : ''}`}
                                                                    >
                                                                        <input {...getInputProps()} disabled={uploadingVariationMedia[originalIndex]} />
                                                                        <div className="space-y-1">
                                                                            {isDragActive ? (
                                                                                <p className="text-xs text-indigo-600 font-medium">Drop the files here...</p>
                                                                            ) : (
                                                                                <>
                                                                                    <p className="text-xs text-gray-600">
                                                                                        <span className="font-medium text-indigo-600">Click to upload</span> or drag and drop media here
                                                                                    </p>
                                                                                    <p className="text-xs text-gray-500">
                                                                                        Images (JPEG, PNG, GIF, WEBP) or Videos (MP4, MOV, AVI)
                                                                                    </p>
                                                                                </>
                                                                            )}
                                                                        </div>
                                                                    </div>

                                                                    {/* Uploading Indicator */}
                                                                    {uploadingVariationMedia[originalIndex] && (
                                                                        <div className="mb-3 text-xs text-indigo-600 text-center">
                                                                            Uploading media...
                                                                        </div>
                                                                    )}

                                                                    {/* Pending Files Preview */}
                                                                    {pendingFiles.length > 0 && (
                                                                        <div className="mb-3">
                                                                            <p className="text-xs text-gray-600 mb-2 font-medium">Pending Upload ({pendingFiles.length}):</p>
                                                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                                                {pendingFiles.map((file, fileIndex) => (
                                                                                    <div key={`pending-${originalIndex}-${fileIndex}`} className="relative group">
                                                                                        {file.type.startsWith('image/') ? (
                                                                                            <img
                                                                                                src={URL.createObjectURL(file)}
                                                                                                alt={`Preview ${fileIndex}`}
                                                                                                className="w-full h-20 object-cover rounded border border-gray-200"
                                                                                            />
                                                                                        ) : (
                                                                                            <div className="w-full h-20 bg-gray-100 rounded border border-gray-200 flex items-center justify-center">
                                                                                                <VideoCameraIcon className="h-6 w-6 text-gray-400" />
                                                                                            </div>
                                                                                        )}
                                                                                        <button
                                                                                            type="button"
                                                                                            onClick={(e) => {
                                                                                                e.stopPropagation();
                                                                                                removePendingVariationFile(originalIndex, file);
                                                                                            }}
                                                                                            className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                                                        >
                                                                                            <XMarkIcon className="h-3 w-3" />
                                                                                        </button>
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        </div>
                                                                    )}

                                                                    {/* Uploaded Media Display */}
                                                                    {hasMedia ? (
                                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                                {variationMedia.map((item: any) => (
                                                                    <div key={item.id} className="relative group">
                                                                        {item.type === 'image' ? (
                                                                            <img
                                                                                src={item.url || (item.file_path ? `/storage/${item.file_path}` : '/placeholder-image.png')}
                                                                                alt={item.file_name || 'Variation image'}
                                                                                className="w-full h-20 object-cover rounded border border-gray-200"
                                                                                onError={(e) => {
                                                                                    (e.target as HTMLImageElement).src = '/placeholder-image.png';
                                                                                }}
                                                                            />
                                                                        ) : (
                                                                            <video
                                                                                src={item.url || (item.file_path ? `/storage/${item.file_path}` : '')}
                                                                                className="w-full h-20 object-cover rounded border border-gray-200"
                                                                                controls
                                                                            />
                                                                        )}
                                                                        <button
                                                                            type="button"
                                                                            onClick={() => handleDeleteMedia(item.id)}
                                                                            className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                                        >
                                                                            <TrashIcon className="h-3 w-3" />
                                                                        </button>
                                                                        {item.color && (
                                                                            <div className="absolute bottom-1 left-1 px-1 py-0.5 bg-black bg-opacity-50 rounded text-xs text-white">
                                                                                {item.color}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                                    ) : (
                                                                        <p className="text-xs text-gray-400 italic text-center">
                                                                            No media uploaded for this variation. Drag and drop or click to upload.
                                                                        </p>
                                                                    )}
                                                                </>
                                                            );
                                                        };

                                                        return <VariationDropzone />;
                                                    })()}
                                                </div>
                                            </div>
                                                );
                                            })}
                                    </div>
                                ) : (
                                    <p className="text-sm text-gray-500">No variations added. Click "Add Variation" to create one.</p>
                                )}
                                    </div>
                                )}
                            </div>

                            {/* Stock Quantity - After Variations */}
                            <div className="border-t pt-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Stock Quantity <span className="text-red-500">*</span>
                                        {variations.length > 0 && (
                                            <span className="ml-2 text-xs text-gray-500 font-normal">(Auto-calculated from variations)</span>
                                        )}
                                    </label>
                                    <input
                                        type="number"
                                        name="total_quantity"
                                        value={formData.total_quantity}
                                        onChange={handleInputChange}
                                        required
                                        min="0"
                                        disabled={variations.length > 0}
                                        className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                                            errors.total_quantity ? 'border-red-300' : 'border-gray-300'
                                        } ${variations.length > 0 ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                                        placeholder="0"
                                    />
                                    {variations.length > 0 && (
                                        <p className="mt-1 text-xs text-gray-500">
                                            Total stock is automatically calculated from all variation stock quantities. To change it, modify individual variation stocks.
                                        </p>
                                    )}
                                    {variations.length === 0 && (
                                        <p className="mt-1 text-xs text-gray-500">
                                            Enter the total stock quantity for this product. If you add variations, this will be auto-calculated.
                                        </p>
                                    )}
                                    {errors.total_quantity && (
                                        <p className="mt-1 text-sm text-red-600">{errors.total_quantity}</p>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Form Actions */}
                        <div className="mt-8 flex justify-end space-x-4 border-t pt-6">
                            <button
                                type="button"
                                onClick={() => router.visit('/admin/products')}
                                className="px-6 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            >
                                {isEditMode || product?.id ? 'Back to Products' : 'Cancel'}
                            </button>
                            <button
                                type="submit"
                                disabled={submitting}
                                className="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {submitting ? 'Saving...' : isEditMode || product?.id ? 'Update Product' : 'Create Product'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </AdminLayout>
    );
}

