import { useState, useEffect, useRef } from 'react';
import { usePage, router, Link } from '@inertiajs/react';
import { useProductStore } from './useProductStore';
import { useCategoryStore } from '../Category/useCategoryStore';
import { useFabricStore } from '../Fabric/useFabricStore';
import AdminLayout from '../Layout';
import toast from '../../../utils/toast';
import { ArrowLeftIcon, XMarkIcon, PlusIcon, TrashIcon, VideoCameraIcon, PhotoIcon } from '@heroicons/react/24/outline';
import { useDropzone } from 'react-dropzone';
import { SketchPicker } from 'react-color';

export default function ProductCreate() {
    const { props } = usePage();
    const productId = (props as any).id;
    const isEditMode = !!productId;
    
    const [categories, setCategories] = useState<any[]>([]);
    const [filteredCategories, setFilteredCategories] = useState<any[]>([]);
    const [categorySearch, setCategorySearch] = useState('');
    const [selectedMainCategory, setSelectedMainCategory] = useState<string>('');
    const [selectedSubCategory, setSelectedSubCategory] = useState<string>('');
    const [selectedSubSubCategory, setSelectedSubSubCategory] = useState<string>('');
    const [selectedCategoryPath, setSelectedCategoryPath] = useState<string[]>([]); // Track full category path
    const [product, setProduct] = useState<any>(null);
    const [loading, setLoading] = useState(false);
    const [formData, setFormData] = useState({
        product_name: '',
        description: '',
        price: '',
        cost_price: '',
        mrp: '',
        discount_percent: '',
        category: '',
        total_quantity: '',
        is_approve: 0,
        is_returnable: false,
        is_replaceable: false,
        return_policy_note: '',
    });
    const [errors, setErrors] = useState<any>({});
    const [submitting, setSubmitting] = useState(false);
    const [media, setMedia] = useState<any[]>([]);
    const [uploadingMedia, setUploadingMedia] = useState(false);
    const [variations, setVariations] = useState<any[]>([]);
    const [selectedFabricIds, setSelectedFabricIds] = useState<number[]>([]);
    const [availableFabrics, setAvailableFabrics] = useState<any[]>([]);
    const [loadingFabrics, setLoadingFabrics] = useState(false);
    const [mediaColor, setMediaColor] = useState('');
    const [pendingMediaFiles, setPendingMediaFiles] = useState<File[]>([]);
    const [showColorPicker, setShowColorPicker] = useState(false);
    const [mediaColorPickers, setMediaColorPickers] = useState<{ [key: number]: boolean }>({});
    const [variationColorPickers, setVariationColorPickers] = useState<{ [key: number]: boolean }>({});
    const [variationColors, setVariationColors] = useState<{ [key: number]: string }>({});
    const [activeMediaTab, setActiveMediaTab] = useState<'images' | 'video'>('images');
    const [pendingImages, setPendingImages] = useState<File[]>([]);
    const [pendingVideos, setPendingVideos] = useState<File[]>([]);
    const [selectedVariationForMedia, setSelectedVariationForMedia] = useState<number | null>(null);
    const [activeMainTab, setActiveMainTab] = useState<'media' | 'variations'>('media');
    const [pendingVariationMedia, setPendingVariationMedia] = useState<{ [key: number]: File[] }>({});
    const [uploadingVariationMedia, setUploadingVariationMedia] = useState<{ [key: number]: boolean }>({});
    const hasAutoGeneratedRef = useRef(false);

    useEffect(() => {
        loadCategories();
        loadFabrics();
        if (isEditMode && productId) {
            loadProduct();
        }
    }, [productId]);

    const loadFabrics = async () => {
        try {
            setLoadingFabrics(true);
            const response = await useFabricStore.list();
            if (response.data?.status) {
                setAvailableFabrics(response.data.data || []);
            }
        } catch (error) {
            console.error('Error loading fabrics:', error);
        } finally {
            setLoadingFabrics(false);
        }
    };

    useEffect(() => {
        if (product) {
            setFormData({
                product_name: product.product_name || '',
                description: product.description || '',
                price: product.price || '',
                cost_price: product.cost_price || '',
                mrp: product.mrp || '',
                discount_percent: product.discount_percent || '',
                category: product.category || '',
                total_quantity: product.total_quantity || '',
                is_approve: product.is_approve || 0,
                is_returnable: product.is_returnable !== undefined ? product.is_returnable : false,
                is_replaceable: product.is_replaceable !== undefined ? product.is_replaceable : false,
                return_policy_note: product.return_policy_note || '',
            });
            
            // Set category hierarchy based on selected category
            if (product.category && categories.length > 0) {
                const selectedCat = categories.find((c: any) => c.id === parseInt(product.category));
                if (selectedCat) {
                    // Find the category path (main -> sub -> sub-sub)
                    if (selectedCat.parent_id) {
                        const parent = categories.find((c: any) => c.id === selectedCat.parent_id);
                        if (parent) {
                            if (parent.parent_id) {
                                // 3 levels: main -> sub -> sub-sub
                                setSelectedMainCategory(parent.parent_id.toString());
                                setSelectedSubCategory(parent.id.toString());
                                setSelectedSubSubCategory(selectedCat.id.toString());
                            } else {
                                // 2 levels: main -> sub
                                setSelectedMainCategory(parent.id.toString());
                                setSelectedSubCategory(selectedCat.id.toString());
                                setSelectedSubSubCategory('');
                            }
                        }
                    } else {
                        // Main category only
                        setSelectedMainCategory(selectedCat.id.toString());
                        setSelectedSubCategory('');
                        setSelectedSubSubCategory('');
                    }
                }
            }
            
            // Format media URLs to ensure they're properly displayed
            const formattedMedia = (product.media || []).map((item: any) => ({
                ...item,
                url: item.url || (item.file_path ? `/storage/${item.file_path}` : null)
            }));
            setMedia(formattedMedia);
            
            setVariations(product.variations || []);
            // Set selected fabric IDs from product fabrics
            if (product.fabrics && product.fabrics.length > 0) {
                setSelectedFabricIds(product.fabrics.map((f: any) => f.id));
            } else {
                setSelectedFabricIds([]);
            }
            // Reset auto-generation flag when product is loaded (edit mode)
            if (product.variations && product.variations.length > 0) {
                hasAutoGeneratedRef.current = true;
            }
        }
    }, [product, categories]);

    // Auto-generation removed - variations are now added manually only

    const loadCategories = async () => {
        try {
            const response = await useCategoryStore.list();
            console.log('Category API Response:', response.data);
            
            if (response.data?.status) {
                // Use flat list for easier selection
                const flatCategories = response.data.data?.flat || response.data.data || [];
                console.log('Loaded categories:', flatCategories.length, flatCategories);
                
                if (flatCategories.length === 0) {
                    console.warn('No categories found in response');
                }
                
                setCategories(flatCategories);
                setFilteredCategories(flatCategories);
            } else {
                console.error('Category API returned non-success status:', response.data);
            }
        } catch (error) {
            console.error('Error loading categories:', error);
            toast({ message: 'Failed to load categories', type: 'error' });
        }
    };

    // Filter categories based on search while maintaining hierarchy
    useEffect(() => {
        if (categorySearch.trim() === '') {
            setFilteredCategories(categories);
        } else {
            const searchLower = categorySearch.toLowerCase();
            const matchedIds = new Set<number>();
            
            // First, find all categories that match the search
            categories.forEach((cat: any) => {
                if (cat.name.toLowerCase().includes(searchLower)) {
                    matchedIds.add(cat.id);
                    
                    // If this is a child category, include its parent
                    if (cat.parent_id) {
                        matchedIds.add(cat.parent_id);
                        // Also include grandparent if exists
                        const parent = categories.find((c: any) => c.id === cat.parent_id);
                        if (parent && parent.parent_id) {
                            matchedIds.add(parent.parent_id);
                        }
                    }
                    
                    // If this is a parent category, include all its children
                    const children = categories.filter((c: any) => c.parent_id === cat.id);
                    children.forEach((child: any) => {
                        matchedIds.add(child.id);
                        // Include grandchildren too
                        const grandchildren = categories.filter((c: any) => c.parent_id === child.id);
                        grandchildren.forEach((grandchild: any) => {
                            matchedIds.add(grandchild.id);
                        });
                    });
                }
            });
            
            // Filter categories to include matched ones and maintain hierarchy
            const filtered = categories.filter((cat: any) => matchedIds.has(cat.id));
            setFilteredCategories(filtered);
        }
    }, [categorySearch, categories]);

    // Get category display name with hierarchy
    const getCategoryDisplayName = (category: any): string => {
        if (!category.parent_id) {
            return category.name;
        }
        
        const parent = categories.find((c: any) => c.id === category.parent_id);
        if (!parent) {
            return category.name;
        }
        
        // Check if parent has a parent (3 levels)
        if (parent.parent_id) {
            const grandParent = categories.find((c: any) => c.id === parent.parent_id);
            if (grandParent) {
                return `${grandParent.name} > ${parent.name} > ${category.name}`;
            }
        }
        
        return `${parent.name} > ${category.name}`;
    };

    // Build hierarchical category options for display
    const buildCategoryOptions = () => {
        if (!filteredCategories || filteredCategories.length === 0) {
            console.warn('No filtered categories available for dropdown');
            return [<option key="no-categories" value="" disabled>No categories available</option>];
        }
        
        const options: JSX.Element[] = [];
        const mainCategories = filteredCategories.filter((cat: any) => !cat.parent_id);
        
        // Check for duplicate category names across different parents
        const categoryNameCounts = new Map<string, number>();
        filteredCategories.forEach((cat: any) => {
            const count = categoryNameCounts.get(cat.name) || 0;
            categoryNameCounts.set(cat.name, count + 1);
        });
        
        if (mainCategories.length === 0) {
            // If no main categories, show all categories (might be all subcategories)
            filteredCategories.forEach((cat: any) => {
                const displayName = categoryNameCounts.get(cat.name) > 1 
                    ? getCategoryDisplayName(cat) 
                    : cat.name;
                options.push(
                    <option key={cat.id} value={cat.id}>
                        {displayName}
                    </option>
                );
            });
            return options;
        }
        
        // Sort main categories by sort_order and name
        const sortedMainCategories = [...mainCategories].sort((a: any, b: any) => {
            if (a.sort_order !== b.sort_order) {
                return (a.sort_order || 0) - (b.sort_order || 0);
            }
            return (a.name || '').localeCompare(b.name || '');
        });
        
        sortedMainCategories.forEach((mainCat: any) => {
            // Add main category
            options.push(
                <option key={mainCat.id} value={mainCat.id}>
                    {mainCat.name}
                </option>
            );
            
            // Add subcategories
            const subCategories = filteredCategories
                .filter((cat: any) => cat.parent_id === mainCat.id)
                .sort((a: any, b: any) => {
                    if (a.sort_order !== b.sort_order) {
                        return (a.sort_order || 0) - (b.sort_order || 0);
                    }
                    return (a.name || '').localeCompare(b.name || '');
                });
            
            subCategories.forEach((subCat: any) => {
                // Show full path for duplicate category names
                const isDuplicate = (categoryNameCounts.get(subCat.name) || 0) > 1;
                const displayName = isDuplicate 
                    ? getCategoryDisplayName(subCat)
                    : subCat.name;
                
                // Add subcategory
                options.push(
                    <option key={subCat.id} value={subCat.id}>
                        &nbsp;&nbsp;└─ {displayName}
                    </option>
                );
                
                // Add sub-subcategories
                const subSubCategories = filteredCategories
                    .filter((cat: any) => cat.parent_id === subCat.id)
                    .sort((a: any, b: any) => {
                        if (a.sort_order !== b.sort_order) {
                            return (a.sort_order || 0) - (b.sort_order || 0);
                        }
                        return (a.name || '').localeCompare(b.name || '');
                    });
                
                subSubCategories.forEach((subSubCat: any) => {
                    // Show full path for duplicate category names
                    const isSubDuplicate = (categoryNameCounts.get(subSubCat.name) || 0) > 1;
                    const subDisplayName = isSubDuplicate 
                        ? getCategoryDisplayName(subSubCat)
                        : subSubCat.name;
                    
                    options.push(
                        <option key={subSubCat.id} value={subSubCat.id}>
                            &nbsp;&nbsp;&nbsp;&nbsp;└─ {subDisplayName}
                        </option>
                    );
                });
            });
        });
        
        return options;
    };

    const loadProduct = async () => {
        try {
            setLoading(true);
            const response = await useProductStore.show({ id: productId });
            if (response.data?.status && response.data?.data) {
                setProduct(response.data.data);
            }
        } catch (error) {
            console.error('Error loading product:', error);
            toast({ message: 'Failed to load product', type: 'error' });
            router.visit('/admin/products');
        } finally {
            setLoading(false);
        }
    };

    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        const { name, value, type } = e.target;
        const checked = (e.target as HTMLInputElement).checked;
        
        // Handle boolean checkboxes differently
        if (name === 'is_returnable') {
            setFormData(prev => ({
                ...prev,
                [name]: checked
            }));
        } else {
            setFormData(prev => ({
                ...prev,
                [name]: type === 'checkbox' ? (checked ? 1 : 0) : value
            }));
        }

        // Clear error for this field
        if (errors[name]) {
            setErrors((prev: any) => {
                const newErrors = { ...prev };
                delete newErrors[name];
                return newErrors;
            });
        }

        // Handle category selection changes
        if (name === 'category') {
            const selectedCategory = categories.find((cat: any) => cat.id === parseInt(value));
            if (selectedCategory && selectedCategory.name.toLowerCase() !== 'fashion') {
                setVariations([]);
                hasAutoGeneratedRef.current = false;
            }
        }
        
        // Handle cascading category selection
        if (name === 'main_category') {
            setSelectedMainCategory(value);
            setSelectedSubCategory('');
            setSelectedSubSubCategory('');
            // Set the final category to main category if no subcategories
            const mainCat = categories.find((c: any) => c.id === parseInt(value));
            if (mainCat) {
                const hasSubcategories = categories.some((c: any) => c.parent_id === mainCat.id);
                if (!hasSubcategories) {
                    setFormData(prev => ({ ...prev, category: value }));
                } else {
                    setFormData(prev => ({ ...prev, category: '' }));
                }
            }
        }
        
        if (name === 'sub_category') {
            setSelectedSubCategory(value);
            setSelectedSubSubCategory('');
            // Set the final category to subcategory if no sub-subcategories
            const subCat = categories.find((c: any) => c.id === parseInt(value));
            if (subCat) {
                const hasSubSubcategories = categories.some((c: any) => c.parent_id === subCat.id);
                if (!hasSubSubcategories) {
                    setFormData(prev => ({ ...prev, category: value }));
                } else {
                    setFormData(prev => ({ ...prev, category: '' }));
                }
            }
        }
        
        // Helper function to check if a category has children
        const hasChildren = (categoryId: number) => {
            return categories.some((c: any) => c.parent_id === categoryId);
        };

        // Handle cascading category selection
        if (name === 'main_category') {
            setSelectedMainCategory(value);
            setSelectedSubCategory('');
            setSelectedSubSubCategory('');
            setSelectedCategoryPath([]);
            const mainCat = categories.find((c: any) => c.id === parseInt(value));
            if (mainCat) {
                if (!hasChildren(mainCat.id)) {
                    setFormData(prev => ({ ...prev, category: value }));
                } else {
                    setFormData(prev => ({ ...prev, category: '' }));
                }
            }
        }
        
        if (name === 'sub_category') {
            setSelectedSubCategory(value);
            setSelectedSubSubCategory('');
            setSelectedCategoryPath([]);
            const subCat = categories.find((c: any) => c.id === parseInt(value));
            if (subCat) {
                if (!hasChildren(subCat.id)) {
                    setFormData(prev => ({ ...prev, category: value }));
                } else {
                    setFormData(prev => ({ ...prev, category: '' }));
                }
            }
        }
        
        if (name === 'sub_sub_category') {
            setSelectedSubSubCategory(value);
            setSelectedCategoryPath([]);
            const subSubCat = categories.find((c: any) => c.id === parseInt(value));
            if (subSubCat) {
                if (!hasChildren(subSubCat.id)) {
                    setFormData(prev => ({ ...prev, category: value }));
                } else {
                    setFormData(prev => ({ ...prev, category: '' }));
                }
            }
        }

        // Handle deeper category levels dynamically
        if (name.startsWith('category_level_')) {
            const level = parseInt(name.replace('category_level_', ''));
            // Update the category path for this level
            const newPath = [...selectedCategoryPath];
            const pathIndex = level - 3;
            newPath[pathIndex] = value;
            // Remove any deeper levels when a new selection is made
            newPath.splice(pathIndex + 1);
            setSelectedCategoryPath(newPath);
            
            const selectedCat = categories.find((c: any) => c.id === parseInt(value));
            if (selectedCat) {
                if (!hasChildren(selectedCat.id)) {
                    setFormData(prev => ({ ...prev, category: value }));
                } else {
                    setFormData(prev => ({ ...prev, category: '' }));
                }
            }
        }
    };

    // Check if current category is Fashion (including parent categories)
    const isFashionCategory = () => {
        // First check if main category is Fashion
        if (selectedMainCategory) {
            const mainCat = categories.find((c: any) => c.id === parseInt(selectedMainCategory));
            if (mainCat && mainCat.name.toLowerCase() === 'fashion') {
                return true;
            }
        }
        
        // Then check if final selected category is Fashion or has Fashion as parent
        if (formData.category) {
            const selectedCategory = categories.find((cat: any) => cat.id === parseInt(formData.category));
            if (selectedCategory) {
                // Check if category name is Fashion (case-insensitive)
                if (selectedCategory.name.toLowerCase() === 'fashion') {
                    return true;
                }
                
                // Also check if parent category is Fashion (for subcategories)
                if (selectedCategory.parent_id) {
                    const parent = categories.find((c: any) => c.id === selectedCategory.parent_id);
                    if (parent && parent.name.toLowerCase() === 'fashion') {
                        return true;
                    }
                    
                    // Check grandparent if exists
                    if (parent && parent.parent_id) {
                        const grandParent = categories.find((c: any) => c.id === parent.parent_id);
                        if (grandParent && grandParent.name.toLowerCase() === 'fashion') {
                            return true;
                        }
                    }
                }
            }
        }
        
        // Also check selected subcategory
        if (selectedSubCategory) {
            const subCat = categories.find((c: any) => c.id === parseInt(selectedSubCategory));
            if (subCat) {
                // Check if subcategory name is Fashion
                if (subCat.name.toLowerCase() === 'fashion') {
                    return true;
                }
                // Check if parent is Fashion
                if (subCat.parent_id) {
                    const parent = categories.find((c: any) => c.id === subCat.parent_id);
                    if (parent && parent.name.toLowerCase() === 'fashion') {
                        return true;
                    }
                }
            }
        }
        
        return false;
    };

    // Check if current category is Footwear (including parent categories)
    const isFootwearCategory = () => {
        // First check if main category is Footwear
        if (selectedMainCategory) {
            const mainCat = categories.find((c: any) => c.id === parseInt(selectedMainCategory));
            if (mainCat && mainCat.name.toLowerCase() === 'footwear') {
                return true;
            }
        }
        
        // Then check if final selected category is Footwear or has Footwear as parent
        if (formData.category) {
            const selectedCategory = categories.find((cat: any) => cat.id === parseInt(formData.category));
            if (selectedCategory) {
                // Check if category name is Footwear (case-insensitive)
                if (selectedCategory.name.toLowerCase() === 'footwear') {
                    return true;
                }
                
                // Also check if parent category is Footwear (for subcategories)
                if (selectedCategory.parent_id) {
                    const parent = categories.find((c: any) => c.id === selectedCategory.parent_id);
                    if (parent && parent.name.toLowerCase() === 'footwear') {
                        return true;
                    }
                    
                    // Check grandparent if exists
                    if (parent && parent.parent_id) {
                        const grandParent = categories.find((c: any) => c.id === parent.parent_id);
                        if (grandParent && grandParent.name.toLowerCase() === 'footwear') {
                            return true;
                        }
                    }
                }
            }
        }
        
        // Also check selected subcategory
        if (selectedSubCategory) {
            const subCat = categories.find((c: any) => c.id === parseInt(selectedSubCategory));
            if (subCat) {
                // Check if subcategory name is Footwear
                if (subCat.name.toLowerCase() === 'footwear') {
                    return true;
                }
                // Check if parent is Footwear
                if (subCat.parent_id) {
                    const parent = categories.find((c: any) => c.id === subCat.parent_id);
                    if (parent && parent.name.toLowerCase() === 'footwear') {
                        return true;
                    }
                }
            }
        }
        
        return false;
    };

    // Check if fashion category is for kids (Boys, Girls, Infants)
    const isKidsFashionCategory = () => {
        if (!isFashionCategory()) {
            return false;
        }

        // Check if main category is Boys, Girls, or Infants
        if (selectedMainCategory) {
            const mainCat = categories.find((c: any) => c.id === parseInt(selectedMainCategory));
            if (mainCat) {
                const mainCatName = mainCat.name.toLowerCase();
                if (mainCatName === 'boys' || mainCatName === 'girls' || mainCatName === 'infants') {
                    return true;
                }
            }
        }

        // Check if final selected category has Boys, Girls, or Infants as parent
        if (formData.category) {
            const selectedCategory = categories.find((cat: any) => cat.id === parseInt(formData.category));
            if (selectedCategory && selectedCategory.parent_id) {
                const parent = categories.find((c: any) => c.id === selectedCategory.parent_id);
                if (parent) {
                    const parentName = parent.name.toLowerCase();
                    if (parentName === 'boys' || parentName === 'girls' || parentName === 'infants') {
                        return true;
                    }
                    
                    // Check grandparent if exists
                    if (parent.parent_id) {
                        const grandParent = categories.find((c: any) => c.id === parent.parent_id);
                        if (grandParent) {
                            const grandParentName = grandParent.name.toLowerCase();
                            if (grandParentName === 'boys' || grandParentName === 'girls' || grandParentName === 'infants') {
                                return true;
                            }
                        }
                    }
                }
            }
        }

        // Check selected subcategory
        if (selectedSubCategory) {
            const subCat = categories.find((c: any) => c.id === parseInt(selectedSubCategory));
            if (subCat && subCat.parent_id) {
                const parent = categories.find((c: any) => c.id === subCat.parent_id);
                if (parent) {
                    const parentName = parent.name.toLowerCase();
                    if (parentName === 'boys' || parentName === 'girls' || parentName === 'infants') {
                        return true;
                    }
                }
            }
        }

        return false;
    };

    // Check if fashion is for infants (smallest sizes)
    const isInfantFashionCategory = () => {
        if (!isKidsFashionCategory()) {
            return false;
        }

        // Check if main category is Infants
        if (selectedMainCategory) {
            const mainCat = categories.find((c: any) => c.id === parseInt(selectedMainCategory));
            if (mainCat && mainCat.name.toLowerCase() === 'infants') {
                return true;
            }
        }

        // Check if final selected category has Infants as parent
        if (formData.category) {
            const selectedCategory = categories.find((cat: any) => cat.id === parseInt(formData.category));
            if (selectedCategory && selectedCategory.parent_id) {
                const parent = categories.find((c: any) => c.id === selectedCategory.parent_id);
                if (parent && parent.name.toLowerCase() === 'infants') {
                    return true;
                }
                
                // Check grandparent if exists
                if (parent && parent.parent_id) {
                    const grandParent = categories.find((c: any) => c.id === parent.parent_id);
                    if (grandParent && grandParent.name.toLowerCase() === 'infants') {
                        return true;
                    }
                }
            }
        }

        // Check selected subcategory
        if (selectedSubCategory) {
            const subCat = categories.find((c: any) => c.id === parseInt(selectedSubCategory));
            if (subCat && subCat.parent_id) {
                const parent = categories.find((c: any) => c.id === subCat.parent_id);
                if (parent && parent.name.toLowerCase() === 'infants') {
                    return true;
                }
            }
        }

        return false;
    };

    // Check if current category is Bottomwear (Jeans, Trousers, Shorts, Track Pants, Skirts)
    const isBottomwearCategory = () => {
        if (!formData.category) return false;
        
        const selectedCategory = categories.find((cat: any) => cat.id === parseInt(formData.category));
        if (!selectedCategory) return false;
        
        const categoryNameLower = selectedCategory.name.toLowerCase();
        const bottomwearCategories = ['jeans', 'trousers', 'casual trousers', 'formal trousers', 'shorts', 'track pants', 'skirts'];
        
        // Check if category name matches bottomwear
        if (bottomwearCategories.some(bw => categoryNameLower.includes(bw))) {
            return true;
        }
        
        return false;
    };

    // Check if bottomwear is for men
    const isMenBottomwearCategory = () => {
        if (!isBottomwearCategory()) return false;
        
        // Check if main category is Men
        if (selectedMainCategory) {
            const mainCat = categories.find((c: any) => c.id === parseInt(selectedMainCategory));
            if (mainCat && mainCat.name.toLowerCase() === 'men') {
                return true;
            }
        }
        
        // Check if final selected category has Men as parent
        if (formData.category) {
            const selectedCategory = categories.find((cat: any) => cat.id === parseInt(formData.category));
            if (selectedCategory && selectedCategory.parent_id) {
                const parent = categories.find((c: any) => c.id === selectedCategory.parent_id);
                if (parent) {
                    const parentName = parent.name.toLowerCase();
                    if (parentName === 'men') {
                        return true;
                    }
                    
                    // Check grandparent if exists
                    if (parent.parent_id) {
                        const grandParent = categories.find((c: any) => c.id === parent.parent_id);
                        if (grandParent && grandParent.name.toLowerCase() === 'men') {
                            return true;
                        }
                    }
                }
            }
        }
        
        return false;
    };

    // Check if current category is Bangle
    const isBangleCategory = () => {
        if (!formData.category) return false;
        
        const selectedCategory = categories.find((cat: any) => cat.id === parseInt(formData.category));
        if (!selectedCategory) return false;
        
        const categoryNameLower = selectedCategory.name.toLowerCase();
        return categoryNameLower === 'bangle';
    };

    // Check if current category is Ring
    const isRingCategory = () => {
        if (!formData.category) return false;
        
        const selectedCategory = categories.find((cat: any) => cat.id === parseInt(formData.category));
        if (!selectedCategory) return false;
        
        const categoryNameLower = selectedCategory.name.toLowerCase();
        return categoryNameLower === 'ring' || categoryNameLower.includes('ring');
    };

    // Check if footwear category is for kids (Boys, Girls, Infants)
    const isKidsFootwearCategory = () => {
        if (!isFootwearCategory()) {
            return false;
        }

        // Check if main category is Boys, Girls, or Infants
        if (selectedMainCategory) {
            const mainCat = categories.find((c: any) => c.id === parseInt(selectedMainCategory));
            if (mainCat) {
                const mainCatName = mainCat.name.toLowerCase();
                if (mainCatName === 'boys' || mainCatName === 'girls' || mainCatName === 'infants') {
                    return true;
                }
            }
        }

        // Check if final selected category has Boys, Girls, or Infants as parent
        if (formData.category) {
            const selectedCategory = categories.find((cat: any) => cat.id === parseInt(formData.category));
            if (selectedCategory && selectedCategory.parent_id) {
                const parent = categories.find((c: any) => c.id === selectedCategory.parent_id);
                if (parent) {
                    const parentName = parent.name.toLowerCase();
                    if (parentName === 'boys' || parentName === 'girls' || parentName === 'infants') {
                        return true;
                    }
                    
                    // Check grandparent if exists
                    if (parent.parent_id) {
                        const grandParent = categories.find((c: any) => c.id === parent.parent_id);
                        if (grandParent) {
                            const grandParentName = grandParent.name.toLowerCase();
                            if (grandParentName === 'boys' || grandParentName === 'girls' || grandParentName === 'infants') {
                                return true;
                            }
                        }
                    }
                }
            }
        }

        // Check selected subcategory
        if (selectedSubCategory) {
            const subCat = categories.find((c: any) => c.id === parseInt(selectedSubCategory));
            if (subCat && subCat.parent_id) {
                const parent = categories.find((c: any) => c.id === subCat.parent_id);
                if (parent) {
                    const parentName = parent.name.toLowerCase();
                    if (parentName === 'boys' || parentName === 'girls' || parentName === 'infants') {
                        return true;
                    }
                }
            }
        }

        return false;
    };

    // Check if footwear is for infants (smallest sizes)
    const isInfantFootwearCategory = () => {
        if (!isKidsFootwearCategory()) {
            return false;
        }

        // Check if main category is Infants
        if (selectedMainCategory) {
            const mainCat = categories.find((c: any) => c.id === parseInt(selectedMainCategory));
            if (mainCat && mainCat.name.toLowerCase() === 'infants') {
                return true;
            }
        }

        // Check if final selected category has Infants as parent
        if (formData.category) {
            const selectedCategory = categories.find((cat: any) => cat.id === parseInt(formData.category));
            if (selectedCategory && selectedCategory.parent_id) {
                const parent = categories.find((c: any) => c.id === selectedCategory.parent_id);
                if (parent && parent.name.toLowerCase() === 'infants') {
                    return true;
                }
                
                // Check grandparent if exists
                if (parent && parent.parent_id) {
                    const grandParent = categories.find((c: any) => c.id === parent.parent_id);
                    if (grandParent && grandParent.name.toLowerCase() === 'infants') {
                        return true;
                    }
                }
            }
        }

        // Check selected subcategory
        if (selectedSubCategory) {
            const subCat = categories.find((c: any) => c.id === parseInt(selectedSubCategory));
            if (subCat && subCat.parent_id) {
                const parent = categories.find((c: any) => c.id === subCat.parent_id);
                if (parent && parent.name.toLowerCase() === 'infants') {
                    return true;
                }
            }
        }

        return false;
    };

    // Check if a variation already exists (duplicate check based on size, color, and gender)
    const isDuplicateVariation = (size: string, color: string, gender: string, excludeIndex?: number): boolean => {
        return variations.some((v: any, index: number) => {
            if (excludeIndex !== undefined && index === excludeIndex) return false;
            
            // Normalize empty strings, null, and undefined values for comparison
            const normalize = (val: any): string => {
                if (val === null || val === undefined) return '';
                return String(val).trim().toLowerCase();
            };
            
            const vSize = normalize(v.size);
            const vColor = normalize(v.color);
            const vGender = normalize(v.gender);
            const checkSize = normalize(size);
            const checkColor = normalize(color);
            const checkGender = normalize(gender);

            // Both size and color must match (case-insensitive)
            const sizeColorMatch = vSize === checkSize && vColor === checkColor;

            // If both variations have gender specified, they must match
            // If one has gender and the other doesn't, they're different
            if (checkGender !== '' && vGender !== '') {
                // Both have gender - all three (size, color, gender) must match
                return sizeColorMatch && vGender === checkGender;
            } else if (checkGender === '' && vGender === '') {
                // Neither has gender - check only size and color
                return sizeColorMatch;
        } else {
                // One has gender, the other doesn't - they're different (not duplicates)
                return false;
        }
        });
    };


    const onDrop = (acceptedFiles: File[]) => {
        if (acceptedFiles.length === 0) return;

        const currentProductId = productId || (product?.id);
        
        // Separate images and videos
        const images = acceptedFiles.filter(file => file.type.startsWith('image/'));
        const videos = acceptedFiles.filter(file => file.type.startsWith('video/'));
        
        // If product exists, upload immediately
        if (currentProductId) {
            uploadMediaFiles(acceptedFiles, currentProductId, selectedVariationForMedia);
        } else {
            // Store files for later upload after product creation
            // Use functional updates to avoid race conditions
            setPendingMediaFiles(prev => [...prev, ...acceptedFiles]);
            setPendingImages(prev => [...prev, ...images]);
            setPendingVideos(prev => [...prev, ...videos]);
            toast({ message: `${acceptedFiles.length} file(s) selected. They will be uploaded after product is created.`, type: 'info' });
        }
    };

    const { getRootProps, getInputProps, isDragActive } = useDropzone({
        onDrop,
        accept: {
            'image/*': ['.jpeg', '.jpg', '.png', '.gif', '.webp'],
            'video/*': ['.mp4', '.mov', '.avi']
        },
        multiple: true
    });

    const uploadMediaFiles = async (files: File[], productIdToUse: number, variationId?: number | string | null, variationColor?: string | null) => {
        try {
            setUploadingMedia(true);
            const formData = new FormData();
            formData.append('product_id', productIdToUse.toString());
            
            // Handle variation_id - send null for general media, or variation ID for variation-specific media
            if (variationId !== null && variationId !== undefined && variationId !== '') {
                // For existing variations, use the ID; for new variations (temp-*), backend will handle after variation is saved
                if (typeof variationId === 'number' || (typeof variationId === 'string' && !variationId.toString().startsWith('temp-'))) {
                    formData.append('variation_id', variationId.toString());
                }
                // For temp variations, we'll link after variation is created (backend handles this)
            } else {
                // Explicitly set to null for general media (no variation)
                formData.append('variation_id', '');
            }
            
            // Determine color to use: from variation parameter, from variation object, or from mediaColor state
            let colorToUse = null;
            
            // Priority 1: Use color from variation parameter (passed directly)
            if (variationColor) {
                colorToUse = variationColor;
            } else if (variationId && variationId !== null && variationId !== '') {
                // Priority 2: Get color from variation object
                // Handle both numeric IDs and temp IDs
                let selectedVariation = null;
                
                    if (typeof variationId === 'string' && variationId.startsWith('temp-')) {
                    // Temp ID - find by index
                        const tempIndex = parseInt(variationId.split('-')[1]);
                    selectedVariation = variations[tempIndex];
                } else {
                    // Numeric ID - find by ID
                    selectedVariation = variations.find((v: any) => {
                        if (v.id && v.id.toString() === variationId.toString()) return true;
                    return false;
                });
                }
                
                if (selectedVariation && selectedVariation.color) {
                    colorToUse = selectedVariation.color;
                }
            }
            
            // Only send color if it's from a variation (not for general media)
            // General product media should not have color
            if (colorToUse && variationId) {
                formData.append('color', colorToUse);
            }
            // Don't send color for general media (when variationId is null)
            
            files.forEach((file) => {
                formData.append('files[]', file);
            });

            const response = await useProductStore.uploadMedia(formData);
            if (response.data?.status) {
                const uploadedMedia = response.data.data;
                // Format URLs to ensure they're properly displayed
                const formattedMedia = uploadedMedia.map((item: any) => ({
                    ...item,
                    url: item.url || (item.file_path ? `/storage/${item.file_path}` : null)
                }));
                // If no media exists yet, set first one as primary (only if not variation-specific)
                if (media.length === 0 && formattedMedia.length > 0 && !variationId) {
                    // First uploaded media is automatically set as primary by backend
                    // But we can ensure it's marked in our state
                    formattedMedia[0].is_primary = true;
                }
                setMedia((prevMedia) => [...prevMedia, ...formattedMedia]);
                setSelectedVariationForMedia(null);
                toast({ message: 'Media uploaded successfully', type: 'success' });
            }
        } catch (error: any) {
            console.error('Error uploading media:', error);
            toast({ message: error.response?.data?.message || 'Failed to upload media', type: 'error' });
        } finally {
            setUploadingMedia(false);
        }
    };

    const uploadPendingMedia = async (savedProductId: number) => {
        if (pendingMediaFiles.length > 0 && savedProductId) {
            const formData = new FormData();
            formData.append('product_id', savedProductId.toString());
            // Don't send color for general product media
            // Note: variation_id will be set after variations are created
            // For now, upload as general media
            
            pendingMediaFiles.forEach((file) => {
                formData.append('files[]', file);
            });

            const response = await useProductStore.uploadMedia(formData);
            if (response.data?.status) {
                const uploadedMedia = response.data.data;
                // Update media state with uploaded media - ensure URLs are properly formatted
                if (uploadedMedia && uploadedMedia.length > 0) {
                    const formattedMedia = uploadedMedia.map((item: any) => ({
                        ...item,
                        url: item.url || (item.file_path ? `/storage/${item.file_path}` : null)
                    }));
                    setMedia((prevMedia) => [...prevMedia, ...formattedMedia]);
                }
                // Clear pending files after successful upload
                setPendingMediaFiles([]);
                setPendingImages([]);
                setPendingVideos([]);
                setSelectedVariationForMedia(null);
                return true;
            }
            throw new Error('Failed to upload media');
        }
        return true;
    };

    const removePendingFile = (file: File, type: 'image' | 'video') => {
        if (type === 'image') {
            setPendingImages(pendingImages.filter(f => f !== file));
        } else {
            setPendingVideos(pendingVideos.filter(f => f !== file));
        }
        setPendingMediaFiles(pendingMediaFiles.filter(f => f !== file));
    };

    const removePendingVariationFile = (variationIndex: number, file: File) => {
        setPendingVariationMedia(prev => ({
            ...prev,
            [variationIndex]: (prev[variationIndex] || []).filter(f => f !== file)
        }));
    };

    const handleVariationMediaDrop = async (acceptedFiles: File[], variationIndex: number, variation: any) => {
        if (acceptedFiles.length === 0) return;

        const currentProductId = productId || (product?.id);
        
        if (currentProductId) {
            // Upload immediately if product exists
            setUploadingVariationMedia(prev => ({ ...prev, [variationIndex]: true }));
            try {
                // Use the current variation from the variations array (which should have the latest ID after update)
                const currentVariation = variations[variationIndex];
                const variationIdToUse = currentVariation?.id || variation.id || null;
                
                await uploadMediaFiles(acceptedFiles, currentProductId, variationIdToUse || `temp-${variationIndex}`, variation.color || currentVariation?.color);
            } catch (error: any) {
                console.error('Error uploading variation media:', error);
                toast({ 
                    message: error.response?.data?.message || 'Failed to upload media. Please try again.', 
                    type: 'error' 
                });
            } finally {
                setUploadingVariationMedia(prev => ({ ...prev, [variationIndex]: false }));
            }
        } else {
            // Store files for later upload after product creation
            setPendingVariationMedia(prev => ({
                ...prev,
                [variationIndex]: [...(prev[variationIndex] || []), ...acceptedFiles]
            }));
            toast({ message: `${acceptedFiles.length} file(s) selected. They will be uploaded after product is created.`, type: 'info' });
        }
    };

    const handleUpdateMediaColor = async (mediaId: number, color: string) => {
        try {
            const response = await useProductStore.updateMedia({ id: mediaId, color });
            if (response.data?.status) {
                setMedia(media.map((m: any) => m.id === mediaId ? { ...m, color } : m));
                toast({ message: 'Media color updated successfully', type: 'success' });
            }
        } catch (error: any) {
            console.error('Error updating media color:', error);
            toast({ message: 'Failed to update media color', type: 'error' });
        }
    };

    const handleSetPrimaryMedia = async (mediaId: number) => {
        try {
            const response = await useProductStore.updateMedia({ id: mediaId, is_primary: true });
            if (response.data?.status) {
                // Update local state: set the selected one as primary, others as not primary
                setMedia(media.map((m: any) => ({
                    ...m,
                    is_primary: m.id === mediaId ? true : false
                })));
                toast({ message: 'Primary media updated successfully', type: 'success' });
            }
        } catch (error: any) {
            console.error('Error setting primary media:', error);
            toast({ message: 'Failed to set primary media', type: 'error' });
        }
    };

    const handleDeleteMedia = async (mediaId: number) => {
        setShowDeleteMediaConfirm(true);
        setMediaToDelete(mediaId);

        try {
            const response = await useProductStore.deleteMedia({ id: mediaId });
            if (response.data?.status) {
                setMedia(media.filter((m: any) => m.id !== mediaId));
                toast({ message: 'Media deleted successfully', type: 'success' });
            }
        } catch (error: any) {
            console.error('Error deleting media:', error);
            toast({ message: 'Failed to delete media', type: 'error' });
        }
    };

    // Render media item component
    const renderMediaItem = (item: any, showColorPicker: boolean = true) => {
        return (
            <>
                <div className="relative group mb-2">
                    {item.type === 'image' ? (
                        <div className="relative">
                            <img
                                src={item.url || (item.file_path ? `/storage/${item.file_path}` : '/placeholder-image.png')}
                                alt={item.file_name || 'Product image'}
                                className="w-full h-32 object-cover rounded-md border border-gray-200"
                                onError={(e) => {
                                    (e.target as HTMLImageElement).src = '/placeholder-image.png';
                                }}
                            />
                            <div className="absolute top-2 left-2 px-2 py-1 bg-white bg-opacity-80 rounded flex items-center space-x-1">
                                <PhotoIcon className="h-3 w-3 text-gray-700" />
                                <span className="text-xs text-gray-700">Image</span>
                            </div>
                        </div>
                    ) : (
                        <div className="relative">
                            <video
                                src={item.url || (item.file_path ? `/storage/${item.file_path}` : '')}
                                className="w-full h-32 object-cover rounded-md border border-gray-200"
                                controls
                            />
                            <div className="absolute top-2 left-2 px-2 py-1 bg-white bg-opacity-80 rounded flex items-center space-x-1">
                                <VideoCameraIcon className="h-3 w-3 text-gray-700" />
                                <span className="text-xs text-gray-700">Video</span>
                            </div>
                        </div>
                    )}
                    {item.is_primary && (
                        <span className="absolute top-2 left-2 px-2 py-1 text-xs font-medium bg-indigo-600 text-white rounded z-10">
                            Primary
                        </span>
                    )}
                    <div className="absolute bottom-2 left-2 right-2 flex justify-between items-center opacity-0 group-hover:opacity-100 transition-opacity z-10">
                        <button
                            type="button"
                            onClick={() => handleSetPrimaryMedia(item.id)}
                            className={`px-2 py-1 text-xs font-medium rounded ${
                                item.is_primary
                                    ? 'bg-indigo-600 text-white'
                                    : 'bg-white text-gray-700 hover:bg-gray-100 shadow'
                            }`}
                            title="Set as Primary"
                        >
                            {item.is_primary ? 'Primary' : 'Set Primary'}
                        </button>
                    </div>
                    <button
                        type="button"
                        onClick={() => handleDeleteMedia(item.id)}
                        className="absolute top-2 right-2 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity z-10"
                    >
                        <TrashIcon className="h-4 w-4" />
                    </button>
                </div>
                {showColorPicker && (
                    <div>
                        <label className="block text-xs font-medium text-gray-700 mb-1">
                            Color: {item.color || 'Not set'}
                        </label>
                        {item.color && (
                            <div
                                className="w-full h-6 rounded border border-gray-300"
                                style={{ backgroundColor: item.color }}
                            />
                        )}
                    </div>
                )}
            </>
        );
    };

    const handleAddVariation = () => {
        // Add a single empty variation (check for duplicates)
            const newVariation = {
                id: null,
                size: '',
                color: '',
            gender: (isFashionCategory() && !isBangleCategory() && !isRingCategory()) ? 'male' : null,
                stock_quantity: 0,
                in_stock: true,
            };
            
            // Check if this exact combination already exists
        const newSize = newVariation.size || '';
        const newColor = newVariation.color || '';
        const newGender = newVariation.gender || '';
        
        if (isDuplicateVariation(newSize, newColor, newGender)) {
            const duplicateMsg = newGender 
                ? `This variation combination (Size: ${newSize || 'empty'}, Color: ${newColor || 'empty'}, Gender: ${newGender}) already exists. Duplicate variations are not allowed.`
                : `This variation combination (Size: ${newSize || 'empty'}, Color: ${newColor || 'empty'}) already exists. Duplicate variations are not allowed.`;
            toast({ message: duplicateMsg, type: 'warning' });
                return;
            }
            
            const updated = [...variations, newVariation];
            setVariations(updated);
            
            // Auto-calculate total stock from variations
            const totalStock = updated.reduce((sum, v) => {
                return sum + (parseInt(v.stock_quantity) || 0);
            }, 0);
            setFormData(prev => ({
                ...prev,
                total_quantity: totalStock.toString()
            }));
    };

    const handleRemoveVariation = (index: number) => {
        const updated = variations.filter((_, i) => i !== index);
        setVariations(updated);
        
        // Recalculate total stock after removal
        if (updated.length > 0) {
            const totalStock = updated.reduce((sum, v) => {
                return sum + (parseInt(v.stock_quantity) || 0);
            }, 0);
            setFormData(prev => ({
                ...prev,
                total_quantity: totalStock.toString()
            }));
        } else {
            // If no variations, allow manual input
            setFormData(prev => ({
                ...prev,
                total_quantity: prev.total_quantity || '0'
            }));
        }
    };

    const handleVariationChange = (index: number, field: string, value: any) => {
        const updated = [...variations];
        const currentVariation = updated[index];
        const newVariation = { ...currentVariation, [field]: value };
        
        // Check for duplicates when changing size, color, or gender
        if (field === 'size' || field === 'color' || field === 'gender') {
            const newSize = field === 'size' ? value : (currentVariation.size || '');
            const newColor = field === 'color' ? value : (currentVariation.color || '');
            const newGender = field === 'gender' ? value : (currentVariation.gender || '');
            
            // Check if this combination already exists (excluding current index)
            if (isDuplicateVariation(newSize, newColor, newGender, index)) {
                const duplicateMsg = newGender 
                    ? `This variation combination (Size: ${newSize || 'empty'}, Color: ${newColor || 'empty'}, Gender: ${newGender}) already exists. Duplicate variations are not allowed.`
                    : `This variation combination (Size: ${newSize || 'empty'}, Color: ${newColor || 'empty'}) already exists. Duplicate variations are not allowed.`;
                toast({ message: duplicateMsg, type: 'warning' });
                return; // Don't update if duplicate
            }
        }
        
        updated[index] = newVariation;
        setVariations(updated);
        
        // Auto-calculate total stock from variations if they exist
        if (updated.length > 0) {
            const totalStock = updated.reduce((sum, v) => {
                return sum + (parseInt(v.stock_quantity) || 0);
            }, 0);
            setFormData(prev => ({
                ...prev,
                total_quantity: totalStock.toString()
            }));
        }
    };

    // Handle fabric selection/deselection
    const handleToggleFabric = (fabricId: number) => {
        setSelectedFabricIds(prev => {
            if (prev.includes(fabricId)) {
                return prev.filter(id => id !== fabricId);
            } else {
                return [...prev, fabricId];
            }
        });
    };

    const handleColorChange = (color: any) => {
        setMediaColor(color.hex);
    };

    const handleVariationColorChange = (index: number, color: any) => {
        setVariationColors({ ...variationColors, [index]: color.hex });
        handleVariationChange(index, 'color', color.hex);
        setVariationColorPickers({ ...variationColorPickers, [index]: false });
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setSubmitting(true);
        setErrors({});

        // Validate for duplicate variations before submitting
        const duplicateVariations: number[] = [];
        variations.forEach((v: any, index: number) => {
            const size = (v.size || '').trim();
            const color = (v.color || '').trim();
            const gender = (v.gender || '').trim();
            
            // Check if this variation is a duplicate (excluding itself)
            if (isDuplicateVariation(size, color, gender, index)) {
                duplicateVariations.push(index + 1); // +1 for user-friendly numbering
            }
        });

        if (duplicateVariations.length > 0) {
            setSubmitting(false);
            toast({ 
                message: `Duplicate variations found at position(s) ${duplicateVariations.join(', ')}. Please remove duplicates before saving.`, 
                type: 'error' 
            });
            return;
        }

        try {
                // Build category path for subcategory fields
                const categoryPath: (number | null)[] = [];
                if (selectedMainCategory) categoryPath.push(parseInt(selectedMainCategory));
                if (selectedSubCategory) categoryPath.push(parseInt(selectedSubCategory));
                if (selectedSubSubCategory) categoryPath.push(parseInt(selectedSubSubCategory));
                selectedCategoryPath.forEach((catId: string) => {
                    if (catId) categoryPath.push(parseInt(catId));
                });
                
                // Fill subcategory_1 through subcategory_6 from category path
                const subcategoryFields: any = {};
                for (let i = 0; i < 6; i++) {
                    subcategoryFields[`subcategory_${i + 1}`] = categoryPath[i + 1] || null; // Skip index 0 (main category)
                }

                // Calculate price from MRP and discount
                const mrp = parseFloat(formData.mrp || 0);
                const discountPercent = formData.discount_percent ? parseFloat(formData.discount_percent) : 0;
                let calculatedPrice = mrp;
                if (discountPercent > 0 && discountPercent < 100) {
                    calculatedPrice = mrp * (1 - discountPercent / 100);
                }

                const submitData: any = {
                ...formData,
                mrp: mrp,
                cost_price: parseFloat(formData.cost_price || 0),
                price: calculatedPrice, // Price is calculated from MRP - discount
                discount_percent: discountPercent,
                category: parseInt(formData.category),
                ...subcategoryFields, // Add subcategory_1 through subcategory_6
                total_quantity: parseInt(formData.total_quantity),
                is_approve: formData.is_approve,
                is_returnable: formData.is_returnable !== undefined ? formData.is_returnable : false,
                is_replaceable: formData.is_replaceable !== undefined ? formData.is_replaceable : false,
                return_policy_note: formData.return_policy_note || null,
                variations: variations.map((v: any) => ({
                    size: v.size || null,
                    color: v.color || null,
                    gender: v.gender || null,
                    stock_quantity: parseInt(v.stock_quantity) || 0,
                    in_stock: v.in_stock !== false,
                })),
                fabric_ids: isFashionCategory() ? selectedFabricIds : [],
            };

            if (isEditMode) {
                submitData.id = productId;
            }

            const response = isEditMode 
                ? await useProductStore.update(submitData)
                : await useProductStore.store(submitData);

            if (response.data?.status) {
                const savedProductId = response.data.data.id || productId;
                const savedVariations = response.data.data.variations || variations;
                
                // Upload pending media files if any (for new products)
                if (!isEditMode && savedProductId && pendingMediaFiles.length > 0) {
                    try {
                        setUploadingMedia(true);
                        await uploadPendingMedia(savedProductId);
                    } catch (error: any) {
                        console.error('Error uploading pending media:', error);
                        toast({ message: error.response?.data?.message || 'Product created but some media failed to upload.', type: 'warning' });
                    } finally {
                        setUploadingMedia(false);
                    }
                }
                
                // Upload pending variation media files if any (for both create and edit mode)
                if (savedProductId && savedVariations && Object.keys(pendingVariationMedia).length > 0) {
                    try {
                        // Upload media for each variation that has pending files
                        for (const [variationIndex, files] of Object.entries(pendingVariationMedia)) {
                            if (files.length > 0) {
                                const index = parseInt(variationIndex);
                                // Use saved variations if available, otherwise use current variations
                                const variation = savedVariations[index] || variations[index];
                                if (variation && variation.id) {
                                    setUploadingVariationMedia(prev => ({ ...prev, [index]: true }));
                                    try {
                                        await uploadMediaFiles(files, savedProductId, variation.id, variation.color);
                                        // Clear pending files for this variation after successful upload
                                        setPendingVariationMedia(prev => {
                                            const updated = { ...prev };
                                            delete updated[index];
                                            return updated;
                                        });
                                    } catch (error: any) {
                                        console.error(`Error uploading media for variation ${index}:`, error);
                                        toast({ message: `Failed to upload media for variation ${index + 1}`, type: 'warning' });
                                    } finally {
                                        setUploadingVariationMedia(prev => ({ ...prev, [index]: false }));
                                    }
                                }
                            }
                        }
                    } catch (error: any) {
                        console.error('Error uploading pending variation media:', error);
                        toast({ message: isEditMode ? 'Product updated but some variation media failed to upload.' : 'Product created but some variation media failed to upload.', type: 'warning' });
                    }
                }
                
                // Reload product data in edit mode to get updated variations and media
                // IMPORTANT: Media is managed separately and should NOT be cleared during product update
                if (isEditMode && savedProductId) {
                    // Store current media as backup before reload to prevent data loss
                    const currentMediaBackup = [...media];
                    const currentMediaCount = currentMediaBackup.length;
                    
                    try {
                        const reloadResponse = await useProductStore.show({ id: savedProductId });
                        if (reloadResponse.data?.status && reloadResponse.data?.data) {
                            const reloadedProduct = reloadResponse.data.data;
                            setProduct(reloadedProduct);
                            
                            // Preserve existing media and merge with reloaded media
                            // Format URLs to ensure they're properly displayed
                            const reloadedMedia = (reloadedProduct.media || []).map((item: any) => ({
                                ...item,
                                url: item.url || (item.file_path ? `/storage/${item.file_path}` : null)
                            }));
                            
                            // CRITICAL: Never clear media if we had media before and reload returns empty
                            // This prevents accidental deletion of media during updates
                            if (reloadedMedia.length === 0 && currentMediaCount > 0) {
                                console.warn('No media returned from reload, preserving existing media to prevent data loss');
                                // Keep existing media unchanged - don't update the state
                                // This ensures media is never accidentally cleared
                            } else if (reloadedMedia.length > 0) {
                                // We have reloaded media - merge intelligently
                                const existingMediaIds = new Set(currentMediaBackup.map((m: any) => m.id).filter((id: any) => id != null));
                                const reloadedMediaIds = new Set(reloadedMedia.map((m: any) => m.id).filter((id: any) => id != null));
                                
                                // Check if we're losing any media
                                const missingMedia = currentMediaBackup.filter((m: any) => {
                                    const mediaId = m.id;
                                    return mediaId != null && !reloadedMediaIds.has(mediaId);
                                });
                                
                                if (missingMedia.length > 0) {
                                    // Some media is missing - merge to preserve it
                                    const finalMedia = [...reloadedMedia, ...missingMedia];
                                    setMedia(finalMedia);
                                    console.warn(`Preserved ${missingMedia.length} media items that were missing from reload`);
                                } else if (reloadedMedia.length >= currentMediaCount) {
                                    // Reloaded media has same or more items - use it
                                    setMedia(reloadedMedia);
                } else {
                                    // Reloaded has fewer items - preserve existing to be safe
                                    console.warn(`Reloaded media (${reloadedMedia.length}) has fewer items than existing (${currentMediaCount}), preserving existing`);
                                    // Keep existing media unchanged
                                }
                            } else {
                                // No reloaded media and no existing media - only set empty if we truly had none
                                if (currentMediaCount === 0) {
                                    setMedia([]);
                                } else {
                                    // We had media but reload returned none - preserve existing
                                    console.warn('Had existing media but reload returned none, preserving existing media');
                                    // Keep existing media unchanged
                                }
                            }
                            
                            // Update variations with fresh data (including new IDs after recreation)
                            const reloadedVariations = reloadedProduct.variations || [];
                            setVariations(reloadedVariations);
                            
                            // Update selected fabric IDs with fresh data
                            if (reloadedProduct.fabrics && reloadedProduct.fabrics.length > 0) {
                                setSelectedFabricIds(reloadedProduct.fabrics.map((f: any) => f.id));
                            } else {
                                setSelectedFabricIds([]);
                            }
                            
                            // Ensure product state is updated so product.id is available for media uploads
                            // This is important for upload-media to work after product update
                        } else {
                            // If reload response is invalid but we have backup media, keep it
                            if (currentMediaCount > 0) {
                                console.warn('Reload response invalid, preserving existing media to prevent data loss');
                                // Don't update media state, keep existing - media is preserved
                            }
                        }
                    } catch (error) {
                        console.error('Error reloading product data:', error);
                        // CRITICAL: Never clear existing media if reload fails
                        if (currentMediaCount > 0) {
                            // Keep existing media state unchanged - media is preserved
                            console.warn('Reload failed, preserving existing media state to prevent data loss');
                        }
                        toast({ message: 'Product updated successfully. Your existing media is preserved.', type: 'success' });
                    }
                }
                
                if (!isEditMode && (pendingMediaFiles.length > 0 || Object.keys(pendingVariationMedia).length > 0)) {
                    toast({ message: 'Product created and media uploaded successfully.', type: 'success' });
                // Wait a bit longer to ensure media upload completes before redirect
                setTimeout(() => {
                        router.visit('/admin/products');
                    }, 1000);
                } else if (isEditMode) {
                    toast({ message: 'Product updated successfully', type: 'success' });
                    // Redirect to listing page after update
                    setTimeout(() => {
                    router.visit('/admin/products');
                }, 1000);
                } else {
                    toast({ message: 'Product created successfully.', type: 'success' });
                    // Wait a bit longer to ensure media upload completes before redirect
                    setTimeout(() => {
                        router.visit('/admin/products');
                    }, 1000);
                }
            } else {
                if (response.data?.errors) {
                    setErrors(response.data.errors);
                } else if (response.data?.message) {
                    setErrors({ general: response.data.message });
                }
            }
        } catch (error: any) {
            console.error('Error saving product:', error);
            if (error.response?.data?.errors) {
                setErrors(error.response.data.errors);
            } else if (error.response?.data?.message) {
                setErrors({ general: error.response.data.message });
            } else {
                setErrors({ general: 'An error occurred while saving the product' });
            }
        } finally {
            setSubmitting(false);
        }
    };

    if (isEditMode && loading) {
        return (
            <AdminLayout currentPath="/admin/products">
                <div className="flex items-center justify-center h-64">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                </div>
            </AdminLayout>
        );
    }

    return (
        <AdminLayout currentPath="/admin/products">
            <div className="space-y-6">
                {/* Back Button */}
                <div>
                    <button
                        onClick={() => router.visit('/admin/products')}
                        className="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 hover:text-gray-900 transition-colors"
                    >
                        <ArrowLeftIcon className="h-5 w-5 mr-2" />
                        Back to Products
                    </button>
                </div>

                {/* Header */}
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                        {isEditMode ? 'Edit Product' : 'Add New Product'}
                    </h1>
                    <p className="mt-2 text-sm text-gray-600">
                        {isEditMode ? 'Update product information' : 'Create a new product for your catalog'}
                    </p>
                </div>

                {/* Form */}
                <div className="bg-white shadow rounded-lg">
                    <form onSubmit={handleSubmit} className="p-6">
                        {errors.general && (
                            <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-md">
                                <p className="text-sm text-red-600">{errors.general}</p>
                            </div>
                        )}

                        <div className="space-y-6">
                            {/* Product Name */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Product Name <span className="text-red-500">*</span>
                                </label>
                                <input
                                    type="text"
                                    name="product_name"
                                    value={formData.product_name}
                                    onChange={handleInputChange}
                                    required
                                    className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                                        errors.product_name ? 'border-red-300' : 'border-gray-300'
                                    }`}
                                    placeholder="Enter product name"
                                />
                                {errors.product_name && (
                                    <p className="mt-1 text-sm text-red-600">{errors.product_name}</p>
                                )}
                            </div>

                            {/* Description */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Description <span className="text-red-500">*</span>
                                </label>
                                <textarea
                                    name="description"
                                    value={formData.description}
                                    onChange={handleInputChange}
                                    required
                                    rows={6}
                                    className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                                        errors.description ? 'border-red-300' : 'border-gray-300'
                                    }`}
                                    placeholder="Enter product description"
                                />
                                {errors.description && (
                                    <p className="mt-1 text-sm text-red-600">{errors.description}</p>
                                )}
                            </div>

                            {/* Category and Price Row */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Category - Cascading Dropdowns */}
                                <div className="space-y-3">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Category <span className="text-red-500">*</span>
                                    </label>
                                    
                                    {/* Main Category */}
                                    <div>
                                        <label className="block text-xs font-medium text-gray-600 mb-1">
                                            Main Category
                                    </label>
                                    <select
                                            name="main_category"
                                            value={selectedMainCategory}
                                        onChange={handleInputChange}
                                            required={!selectedMainCategory}
                                            className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm ${
                                            errors.category ? 'border-red-300' : 'border-gray-300'
                                        }`}
                                            disabled={categories.length === 0}
                                    >
                                            <option value="">Select main category</option>
                                            {categories
                                                .filter((cat: any) => !cat.parent_id)
                                                .sort((a: any, b: any) => {
                                                    if (a.sort_order !== b.sort_order) {
                                                        return (a.sort_order || 0) - (b.sort_order || 0);
                                                    }
                                                    return (a.name || '').localeCompare(b.name || '');
                                                })
                                                .map((category: any) => (
                                            <option key={category.id} value={category.id}>
                                                {category.name}
                                            </option>
                                        ))}
                                    </select>
                                    </div>
                                    
                                    {/* Sub Category */}
                                    {selectedMainCategory && (
                                        <div>
                                            <label className="block text-xs font-medium text-gray-600 mb-1">
                                                Sub Category
                                            </label>
                                            <select
                                                name="sub_category"
                                                value={selectedSubCategory}
                                                onChange={handleInputChange}
                                                className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm ${
                                                    errors.category ? 'border-red-300' : 'border-gray-300'
                                                }`}
                                            >
                                                <option value="">Select sub category (optional)</option>
                                                {categories
                                                    .filter((cat: any) => cat.parent_id === parseInt(selectedMainCategory))
                                                    .sort((a: any, b: any) => {
                                                        if (a.sort_order !== b.sort_order) {
                                                            return (a.sort_order || 0) - (b.sort_order || 0);
                                                        }
                                                        return (a.name || '').localeCompare(b.name || '');
                                                    })
                                                    .map((category: any) => (
                                                        <option key={category.id} value={category.id}>
                                                            {category.name}
                                                        </option>
                                                    ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* Sub-Sub Category and deeper levels */}
                                    {selectedSubCategory && (() => {
                                        // Helper function to get children of a category
                                        const getChildren = (parentId: number) => {
                                            return categories
                                                .filter((cat: any) => cat.parent_id === parentId)
                                                .sort((a: any, b: any) => {
                                                    if (a.sort_order !== b.sort_order) {
                                                        return (a.sort_order || 0) - (b.sort_order || 0);
                                                    }
                                                    return (a.name || '').localeCompare(b.name || '');
                                                });
                                        };

                                        // Helper function to check if a category has children
                                        const hasChildren = (categoryId: number) => {
                                            return categories.some((c: any) => c.parent_id === categoryId);
                                        };

                                        // Render category dropdowns recursively
                                        const renderCategoryLevel = (level: number, parentId: number, selectedValue: string): any => {
                                            const children = getChildren(parentId);
                                            if (children.length === 0) return null;

                                            const levelName = level === 2 ? 'sub_sub_category' : `category_level_${level}`;
                                            const levelLabel = level === 2 ? 'Sub-Sub Category' : `Level ${level + 1} Category`;
                                            
                                            // Get the selected value for this level
                                            let currentSelectedValue = '';
                                            if (level === 2) {
                                                currentSelectedValue = selectedSubSubCategory;
                                            } else {
                                                const pathIndex = level - 3;
                                                currentSelectedValue = selectedCategoryPath[pathIndex] || '';
                                            }

                                            return (
                                                <div key={level}>
                                                    <label className="block text-xs font-medium text-gray-600 mb-1">
                                                        {levelLabel}
                                                    </label>
                                                    <select
                                                        name={levelName}
                                                        value={currentSelectedValue}
                                                        onChange={handleInputChange}
                                                        className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm ${
                                                            errors.category ? 'border-red-300' : 'border-gray-300'
                                                        }`}
                                                    >
                                                        <option value="">Select {levelLabel.toLowerCase()} (optional)</option>
                                                        {children.map((category: any) => (
                                                            <option key={category.id} value={category.id}>
                                                                {category.name}
                                                            </option>
                                                        ))}
                                                    </select>
                                                    {/* Recursively render next level if current selection has children */}
                                                    {currentSelectedValue && hasChildren(parseInt(currentSelectedValue)) && 
                                                        renderCategoryLevel(level + 1, parseInt(currentSelectedValue), '')
                                                    }
                                                </div>
                                            );
                                        };

                                        return renderCategoryLevel(2, parseInt(selectedSubCategory), selectedSubSubCategory);
                                    })()}
                                    
                                    {/* Hidden input for final category selection */}
                                    <input type="hidden" name="category" value={formData.category} />
                                    
                                    {errors.category && (
                                        <p className="mt-1 text-sm text-red-600">{errors.category}</p>
                                    )}
                                    
                                    {formData.category && (() => {
                                        const selectedCat = categories.find((c: any) => c.id === parseInt(formData.category));
                                        if (!selectedCat) return null;
                                        const displayName = getCategoryDisplayName(selectedCat);
                                        return (
                                            <p className="mt-1 text-xs text-gray-500">
                                                Selected: <span className="font-medium">{displayName}</span>
                                            </p>
                                        );
                                    })()}
                                    
                                    {categories.length === 0 && (
                                        <p className="mt-1 text-xs text-yellow-600">
                                            No categories found. Please create categories first.
                                        </p>
                                    )}
                                </div>

                                {/* Pricing Section */}
                                <div className="space-y-6">
                                    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border-2 border-indigo-200">
                                        <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                            <svg className="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            Pricing & Profit
                                        </h3>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {/* Cost Price (Purchase Price) */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Cost Price (Purchase Price) <span className="text-red-500">*</span>
                                                </label>
                                                <input
                                                    type="number"
                                                    name="cost_price"
                                                    value={formData.cost_price}
                                                    onChange={handleInputChange}
                                                    required
                                                    min="0"
                                                    step="0.01"
                                                    className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                                                        errors.cost_price ? 'border-red-300' : 'border-gray-300'
                                                    }`}
                                                    placeholder="0.00"
                                                />
                                                <p className="mt-1 text-xs text-gray-500">What you paid to purchase this product</p>
                                                {errors.cost_price && (
                                                    <p className="mt-1 text-sm text-red-600">{errors.cost_price}</p>
                                                )}
                                            </div>

                                            {/* MRP (Selling Price) */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    MRP (Selling Price) <span className="text-red-500">*</span>
                                                </label>
                                                <input
                                                    type="number"
                                                    name="mrp"
                                                    value={formData.mrp || ''}
                                                    onChange={handleInputChange}
                                                    required
                                                    min="0"
                                                    step="0.01"
                                                    className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                                                        errors.mrp ? 'border-red-300' : 'border-gray-300'
                                                    }`}
                                                    placeholder="0.00"
                                                />
                                                <p className="mt-1 text-xs text-gray-500">Maximum Retail Price (what you sell it for)</p>
                                                {errors.mrp && (
                                                    <p className="mt-1 text-sm text-red-600">{errors.mrp}</p>
                                                )}
                                            </div>

                                            {/* Discount Percent */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Discount Percent (%)
                                                </label>
                                                <input
                                                    type="number"
                                                    name="discount_percent"
                                                    value={formData.discount_percent}
                                                    onChange={handleInputChange}
                                                    min="0"
                                                    max="100"
                                                    step="0.01"
                                                    className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                                                        errors.discount_percent ? 'border-red-300' : 'border-gray-300'
                                                    }`}
                                                    placeholder="0.00"
                                                />
                                                <p className="mt-1 text-xs text-gray-500">Optional discount applied to MRP</p>
                                                {errors.discount_percent && (
                                                    <p className="mt-1 text-sm text-red-600">{errors.discount_percent}</p>
                                                )}
                                            </div>

                                            {/* Final Price (Calculated) */}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Final Selling Price
                                                </label>
                                                <div className="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700 font-semibold">
                                                    ₹{(() => {
                                                        const mrp = parseFloat(formData.mrp || 0);
                                                        const discount = parseFloat(formData.discount_percent || 0);
                                                        if (discount > 0 && discount < 100) {
                                                            return ((mrp * (1 - discount / 100))).toFixed(2);
                                                        }
                                                        return mrp.toFixed(2);
                                                    })()}
                                                </div>
                                                <p className="mt-1 text-xs text-gray-500">MRP - Discount (calculated automatically)</p>
                                            </div>
                                        </div>

                                        {/* Profit & Revenue Summary */}
                                        {(() => {
                                            const costPrice = parseFloat(formData.cost_price || 0);
                                            const mrp = parseFloat(formData.mrp || 0);
                                            const discount = parseFloat(formData.discount_percent || 0);
                                            const finalPrice = discount > 0 && discount < 100 ? (mrp * (1 - discount / 100)) : mrp;
                                            const profit = finalPrice - costPrice;
                                            // Profit Margin = (Profit / Final Selling Price) × 100
                                            const profitMargin = finalPrice > 0 ? ((profit / finalPrice) * 100) : 0;
                                            // Markup = (Profit / Cost Price) × 100
                                            const markup = costPrice > 0 ? ((profit / costPrice) * 100) : 0;
                                            
                                            return (
                                                <div className="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                                                    <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                        <p className="text-xs text-gray-500 mb-1">Cost Price</p>
                                                        <p className="text-lg font-bold text-gray-700">₹{costPrice.toFixed(2)}</p>
                                                    </div>
                                                    <div className="bg-white rounded-lg p-3 border border-gray-200">
                                                        <p className="text-xs text-gray-500 mb-1">Final Selling Price</p>
                                                        <p className="text-lg font-bold text-indigo-600">₹{finalPrice.toFixed(2)}</p>
                                                    </div>
                                                    <div className={`bg-white rounded-lg p-3 border-2 ${
                                                        profit >= 0 ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'
                                                    }`}>
                                                        <p className="text-xs text-gray-600 mb-1">Profit per Unit</p>
                                                        <p className={`text-lg font-bold ${
                                                            profit >= 0 ? 'text-green-600' : 'text-red-600'
                                                        }`}>
                                                            ₹{profit.toFixed(2)}
                                                        </p>
                                                    </div>
                                                    <div className={`bg-white rounded-lg p-3 border-2 ${
                                                        profitMargin >= 0 ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'
                                                    }`}>
                                                        <p className="text-xs text-gray-600 mb-1">Profit Margin</p>
                                                        <p className={`text-lg font-bold ${
                                                            profitMargin >= 0 ? 'text-green-600' : 'text-red-600'
                                                        }`}>
                                                            {profitMargin.toFixed(2)}%
                                                        </p>
                                                        <p className="text-xs text-gray-500 mt-1">of selling price</p>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                </div>
                            </div>

                            {/* Approval Status */}
                            <div>
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        name="is_approve"
                                        id="is_approve"
                                        checked={formData.is_approve === 1}
                                        onChange={handleInputChange}
                                        className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                    />
                                    <label htmlFor="is_approve" className="ml-2 block text-sm text-gray-900">
                                        Approve Product
                                    </label>
                                </div>
                            </div>

                            {/* Return/Refund Settings */}
                            <div className="border-t pt-6">
                                <h3 className="text-lg font-semibold text-gray-900 mb-4">Return/Refund Settings</h3>
                                
                                <div className="space-y-4">
                                    {/* Is Returnable */}
                                    <div>
                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                name="is_returnable"
                                                id="is_returnable"
                                                checked={formData.is_returnable === true}
                                                onChange={(e) => setFormData({ ...formData, is_returnable: e.target.checked })}
                                                className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                            />
                                            <label htmlFor="is_returnable" className="ml-2 block text-sm text-gray-900">
                                                Product is Returnable & Refundable
                                            </label>
                                        </div>
                                        <p className="mt-1 text-xs text-gray-500">
                                            Uncheck if this product cannot be returned or refunded
                                        </p>
                                    </div>

                                    {/* Is Replaceable */}
                                    <div>
                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                name="is_replaceable"
                                                id="is_replaceable"
                                                checked={formData.is_replaceable === true}
                                                onChange={(e) => setFormData({ ...formData, is_replaceable: e.target.checked })}
                                                className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                            />
                                            <label htmlFor="is_replaceable" className="ml-2 block text-sm text-gray-900">
                                                Product is Replaceable
                                            </label>
                                        </div>
                                        <p className="mt-1 text-xs text-gray-500">
                                            Uncheck if this product cannot be replaced (only return/refund allowed)
                                        </p>
                                    </div>

                                    {/* Return Policy Note */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Return Policy Note (Optional)
                                        </label>
                                        <textarea
                                            name="return_policy_note"
                                            value={formData.return_policy_note}
                                            onChange={handleInputChange}
                                            rows={3}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                            placeholder="e.g., Returnable within 7 days, items must be unused and in original packaging..."
                                        />
                                        <p className="mt-1 text-xs text-gray-500">
                                            This note will be displayed to customers on the product page
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Product Media & Variations Tabs */}
                            <div className="border-t pt-6">
                                {/* Tab Navigation */}
                                <div className="border-b border-gray-200 mb-6">
                                    <nav className="flex space-x-8">
                                        <button
                                            type="button"
                                            onClick={() => setActiveMainTab('media')}
                                            className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                                activeMainTab === 'media'
                                                    ? 'border-indigo-500 text-indigo-600'
                                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                            }`}
                                        >
                                            Product Media
                                            <span className="ml-2 text-xs bg-gray-100 px-2 py-0.5 rounded">
                                                {media.filter((m: any) => !m.variation_id).length}
                                            </span>
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setActiveMainTab('variations')}
                                            className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                                activeMainTab === 'variations'
                                                    ? 'border-indigo-500 text-indigo-600'
                                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                            }`}
                                        >
                                            Product Variations
                                            <span className="ml-2 text-xs bg-gray-100 px-2 py-0.5 rounded">
                                                {variations.length}
                                            </span>
                                        </button>
                                    </nav>
                                </div>

                                {/* Tab Content: Product Media */}
                                {activeMainTab === 'media' && (
                                    <div>
                                        <div className="mb-4">
                                            <h3 className="text-lg font-medium text-gray-900">Product Media</h3>
                                            <p className="text-sm text-gray-500 mt-1">
                                                General product media (not linked to any variation).
                                            </p>
                                        </div>
                                        
                                        {/* Ensure no variation is selected for general media */}
                                        {selectedVariationForMedia !== null && (
                                            <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                                                <p className="text-sm text-yellow-800">
                                                    <strong>Warning:</strong> A variation is selected. This will upload variation-specific media.
                                                    <button
                                                        type="button"
                                                        onClick={() => setSelectedVariationForMedia(null)}
                                                        className="ml-2 text-yellow-900 underline"
                                                    >
                                                        Clear selection to upload general media
                                                    </button>
                                                </p>
                                            </div>
                                        )}
                                        
                                        {/* Media Upload Tabs */}
                                    <div className="mb-4">
                                        <div className="border-b border-gray-200">
                                            <nav className="flex space-x-8">
                                                <button
                                                    type="button"
                                                    onClick={() => setActiveMediaTab('images')}
                                                    className={`py-2 px-1 border-b-2 font-medium text-sm ${
                                                        activeMediaTab === 'images'
                                                            ? 'border-indigo-500 text-indigo-600'
                                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                                    }`}
                                                >
                                                    IMAGES
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => setActiveMediaTab('video')}
                                                    className={`py-2 px-1 border-b-2 font-medium text-sm ${
                                                        activeMediaTab === 'video'
                                                            ? 'border-indigo-500 text-indigo-600'
                                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                                    }`}
                                                >
                                                    VIDEO
                                                </button>
                                            </nav>
                                        </div>

                                        {/* Upload Area */}
                                        <div className="mt-4">
                                            <div
                                                {...getRootProps()}
                                                className={`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${
                                                    isDragActive
                                                        ? 'border-indigo-500 bg-indigo-50'
                                                        : 'border-gray-300 hover:border-indigo-400 hover:bg-gray-50'
                                                } ${uploadingMedia ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            >
                                                <input {...getInputProps()} disabled={uploadingMedia} />
                                                <div className="space-y-2">
                                                    {activeMediaTab === 'images' ? (
                                                        <PhotoIcon className="mx-auto h-12 w-12 text-gray-400" />
                                                    ) : (
                                                        <VideoCameraIcon className="mx-auto h-12 w-12 text-gray-400" />
                                                    )}
                                                    {isDragActive ? (
                                                        <p className="text-sm text-indigo-600 font-medium">Drop the files here...</p>
                                                    ) : (
                                                        <>
                                                            <p className="text-sm text-gray-600">
                                                                <span className="font-medium text-indigo-600">Click to upload</span> or drag and drop your {activeMediaTab === 'images' ? 'image' : 'video'} here
                                                            </p>
                                                            <p className="text-xs text-gray-500">
                                                                {activeMediaTab === 'images' 
                                                                    ? 'Images (JPEG, PNG, GIF, WEBP)'
                                                                    : 'Videos (MP4, MOV, AVI)'
                                                                }
                                                            </p>
                                                        </>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Pending Images Preview */}
                                            {activeMediaTab === 'images' && (pendingImages.length > 0 || media.filter((m: any) => m.type === 'image').length > 0) && (
                                                <div className="mt-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                                    {/* Pending Images */}
                                                    {pendingImages.map((file, index) => (
                                                        <div key={`pending-${index}`} className="relative group">
                                                            <img
                                                                src={URL.createObjectURL(file)}
                                                                alt={`Preview ${index}`}
                                                                className="w-full h-32 object-cover rounded-md border border-gray-200"
                                                            />
                                                            <button
                                                                type="button"
                                                                onClick={() => removePendingFile(file, 'image')}
                                                                className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                            >
                                                                <XMarkIcon className="h-4 w-4" />
                                                            </button>
                                                        </div>
                                                    ))}
                                                    {/* Uploaded Images */}
                                                    {media.filter((m: any) => m.type === 'image').map((item: any) => {
                                                        const imageUrl = item.url || (item.file_path ? `/storage/${item.file_path}` : null);
                                                        return (
                                                        <div key={item.id} className="relative group">
                                                            <img
                                                                src={imageUrl || '/placeholder-image.png'}
                                                                alt={item.file_name || 'Product image'}
                                                                className="w-full h-32 object-cover rounded-md border border-gray-200"
                                                                onError={(e) => {
                                                                    (e.target as HTMLImageElement).src = '/placeholder-image.png';
                                                                }}
                                                            />
                                                            {item.is_primary && (
                                                                <span className="absolute top-1 left-1 px-2 py-1 text-xs font-medium bg-indigo-600 text-white rounded">
                                                                    Primary
                                                                </span>
                                                            )}
                                                            <div className="absolute bottom-1 left-1 right-1 flex justify-between items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button
                                                                    type="button"
                                                                    onClick={() => handleSetPrimaryMedia(item.id)}
                                                                    className={`px-2 py-1 text-xs font-medium rounded ${
                                                                        item.is_primary
                                                                            ? 'bg-indigo-600 text-white'
                                                                            : 'bg-white text-gray-700 hover:bg-gray-100 shadow'
                                                                    }`}
                                                                    title="Set as Primary"
                                                                >
                                                                    {item.is_primary ? 'Primary' : 'Set Primary'}
                                                                </button>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={() => handleDeleteMedia(item.id)}
                                                                className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                            >
                                                                <XMarkIcon className="h-4 w-4" />
                                                            </button>
                                                        </div>
                                                        );
                                                    })}
                                                </div>
                                            )}

                                            {/* Pending Videos Preview */}
                                            {activeMediaTab === 'video' && (pendingVideos.length > 0 || media.filter((m: any) => m.type === 'video').length > 0) && (
                                                <div className="mt-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                                    {/* Pending Videos */}
                                                    {pendingVideos.map((file, index) => (
                                                        <div key={`pending-video-${index}`} className="relative group">
                                                            <video
                                                                src={URL.createObjectURL(file)}
                                                                className="w-full h-32 object-cover rounded-md border border-gray-200"
                                                                controls
                                                            />
                                                            <button
                                                                type="button"
                                                                onClick={() => removePendingFile(file, 'video')}
                                                                className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                            >
                                                                <XMarkIcon className="h-4 w-4" />
                                                            </button>
                                                        </div>
                                                    ))}
                                                    {/* Uploaded Videos */}
                                                    {media.filter((m: any) => m.type === 'video').map((item: any) => {
                                                        const videoUrl = item.url || (item.file_path ? `/storage/${item.file_path}` : '');
                                                        return (
                                                        <div key={item.id} className="relative group">
                                                            <video
                                                                src={videoUrl}
                                                                className="w-full h-32 object-cover rounded-md border border-gray-200"
                                                                controls
                                                            />
                                                            {item.is_primary && (
                                                                <span className="absolute top-1 left-1 px-2 py-1 text-xs font-medium bg-indigo-600 text-white rounded">
                                                                    Primary
                                                                </span>
                                                            )}
                                                            <div className="absolute bottom-1 left-1 right-1 flex justify-between items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button
                                                                    type="button"
                                                                    onClick={() => handleSetPrimaryMedia(item.id)}
                                                                    className={`px-2 py-1 text-xs font-medium rounded ${
                                                                        item.is_primary
                                                                            ? 'bg-indigo-600 text-white'
                                                                            : 'bg-white text-gray-700 hover:bg-gray-100'
                                                                    }`}
                                                                    title="Set as Primary"
                                                                >
                                                                    {item.is_primary ? 'Primary' : 'Set Primary'}
                                                                </button>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={() => handleDeleteMedia(item.id)}
                                                                className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                            >
                                                                <XMarkIcon className="h-4 w-4" />
                                                            </button>
                                                        </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                        
                                        {uploadingMedia && (
                                            <p className="text-sm text-gray-500">Uploading...</p>
                                        )}
                                    </div>

                                    {/* Media Gallery - General Product Media Only */}
                                    {media.filter((m: any) => !m.variation_id).length > 0 && (
                                        <div className="mt-6 border-t pt-6">
                                            <h4 className="text-sm font-medium text-gray-900 mb-4">General Product Media Gallery</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                                {media.filter((m: any) => !m.variation_id).map((item: any) => (
                                                    <div key={item.id} className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                                        {renderMediaItem(item)}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {media.filter((m: any) => !m.variation_id).length === 0 && (
                                        <div className="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                            <p className="text-sm text-gray-500 text-center">
                                                No general media uploaded yet. Use the upload area above to add general product media.
                                            </p>
                                        </div>
                                    )}
                                    </div>
                                )}

                                {/* Tab Content: Product Variations */}
                                {activeMainTab === 'variations' && (
                                    <div>
                                        <div className="mb-4">
                                            <div className="flex justify-between items-center mb-2">
                                                <h3 className="text-lg font-medium text-gray-900">Product Variations</h3>
                                                <button
                                                    type="button"
                                                    onClick={handleAddVariation}
                                                    className="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700"
                                                >
                                                    <PlusIcon className="h-4 w-4 mr-1" />
                                                    Add Variation
                                                </button>
                                            </div>
                                            <p className="text-sm text-gray-500">
                                                Manage product variations (size, color, gender). Each variation can have its own media.
                                                Media color is automatically set from the variation's color.
                                            </p>
                                        </div>

                                {variations.length > 0 ? (
                                    <div className="space-y-4">
                                        {/* Sort variations: by gender, then by size for better display */}
                                        {[...variations].map((v: any, originalIndex: number) => ({ ...v, _originalIndex: originalIndex }))
                                            .sort((a: any, b: any) => {
                                            // Sort by gender first (male, female)
                                            const genderOrder = { 'male': 1, 'female': 2 };
                                            const genderA = genderOrder[a.gender as keyof typeof genderOrder] || 4;
                                            const genderB = genderOrder[b.gender as keyof typeof genderOrder] || 4;
                                            if (genderA !== genderB) return genderA - genderB;
                                            
                                            // Then sort by size
                                            if (isBangleCategory()) {
                                                // Bangle sizes: numeric sorting (inches - 2.0, 2.25, 2.5, etc.)
                                                const sizeA = parseFloat(a.size || '0') || 0;
                                                const sizeB = parseFloat(b.size || '0') || 0;
                                                return sizeA - sizeB;
                                            } else if (isRingCategory()) {
                                                // Ring sizes: numeric sorting (4, 5, 6, 7, etc.)
                                                const sizeA = parseInt(a.size || '0') || 0;
                                                const sizeB = parseInt(b.size || '0') || 0;
                                                return sizeA - sizeB;
                                            } else if (isFootwearCategory()) {
                                                // Footwear sizes: numeric sorting (all footwear sizes are numeric)
                                                const sizeA = parseInt(a.size || '0') || 0;
                                                const sizeB = parseInt(b.size || '0') || 0;
                                                return sizeA - sizeB;
                                            } else if (isFashionCategory()) {
                                                if (isBottomwearCategory()) {
                                                    // Bottomwear sizes: numeric sorting (waist sizes)
                                                    const sizeA = parseInt(a.size || '0') || 0;
                                                    const sizeB = parseInt(b.size || '0') || 0;
                                                    return sizeA - sizeB;
                                                } else if (isInfantFashionCategory()) {
                                                    // Infant sizes: age-based sorting
                                                    const sizeOrder = ['0M-3M', '3M-6M', '6M-9M', '9M-12M', '12M-18M', '18M-24M', 'Newborn', '2T', '3T', '4T'];
                                                    const sizeA = sizeOrder.indexOf(a.size || '');
                                                    const sizeB = sizeOrder.indexOf(b.size || '');
                                                    if (sizeA !== -1 && sizeB !== -1) return sizeA - sizeB;
                                                    if (sizeA !== -1) return -1;
                                                    if (sizeB !== -1) return 1;
                                                    return (a.size || '').localeCompare(b.size || '');
                                                } else if (isKidsFashionCategory()) {
                                                    // Kids sizes: age-based sorting
                                                    const sizeOrder = ['0M-3M', '3M-6M', '6M-9M', '9M-12M', '12M-18M', '18M-24M', 'Newborn', '2Y-4Y', '4Y-6Y', '6Y-8Y', '8Y-10Y', '10Y-12Y', '12Y-14Y', '14Y+'];
                                                    const sizeA = sizeOrder.indexOf(a.size || '');
                                                    const sizeB = sizeOrder.indexOf(b.size || '');
                                                    if (sizeA !== -1 && sizeB !== -1) return sizeA - sizeB;
                                                    if (sizeA !== -1) return -1;
                                                    if (sizeB !== -1) return 1;
                                                    return (a.size || '').localeCompare(b.size || '');
                                                } else {
                                                    // Adult fashion sizes: alphabetical sorting
                                                    const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', 'XXL', 'XXXL'];
                                                    const sizeA = sizeOrder.indexOf(a.size || '');
                                                    const sizeB = sizeOrder.indexOf(b.size || '');
                                                    return sizeA - sizeB;
                                                }
                                            } else {
                                                // Default: alphabetical sorting
                                                const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', 'XXL', 'XXXL'];
                                                const sizeA = sizeOrder.indexOf(a.size || '');
                                                const sizeB = sizeOrder.indexOf(b.size || '');
                                                return sizeA - sizeB;
                                            }
                                            })
                                            .map((variation: any, sortedIndex: number) => {
                                                // Use original index from the variation object, not the sorted index
                                                const originalIndex = variation._originalIndex;
                                                return (
                                            <div key={`variation-${originalIndex}-${variation.id || sortedIndex}`} className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                <div className={`grid grid-cols-1 gap-4 ${isFashionCategory() ? 'md:grid-cols-5' : 'md:grid-cols-4'}`}>
                                                    {isFashionCategory() && !isBangleCategory() && !isRingCategory() && (
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                                Gender
                                                            </label>
                                                            <select
                                                                value={variation.gender || ''}
                                                                onChange={(e) => handleVariationChange(originalIndex, 'gender', e.target.value)}
                                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                            >
                                                                <option value="">Select Gender</option>
                                                                <option value="male">Male</option>
                                                                <option value="female">Female</option>
                                                            </select>
                                                        </div>
                                                    )}
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                                            Size
                                                        </label>
                                                        <select
                                                            value={variation.size || ''}
                                                            onChange={(e) => handleVariationChange(originalIndex, 'size', e.target.value)}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                        >
                                                            <option value="">Select Size</option>
                                                            {isFootwearCategory() ? (
                                                                isInfantFootwearCategory() ? (
                                                                    // Infant footwear sizes (1-5)
                                                                    <>
                                                                        <option value="1">1</option>
                                                                        <option value="2">2</option>
                                                                        <option value="3">3</option>
                                                                        <option value="4">4</option>
                                                                        <option value="5">5</option>
                                                                    </>
                                                                ) : isKidsFootwearCategory() ? (
                                                                    // Kids footwear sizes (Boys/Girls: 1-13)
                                                                    <>
                                                                        <option value="1">1</option>
                                                                        <option value="2">2</option>
                                                                        <option value="3">3</option>
                                                                        <option value="4">4</option>
                                                                        <option value="5">5</option>
                                                                        <option value="6">6</option>
                                                                        <option value="7">7</option>
                                                                        <option value="8">8</option>
                                                                        <option value="9">9</option>
                                                                        <option value="10">10</option>
                                                                        <option value="11">11</option>
                                                                        <option value="12">12</option>
                                                                        <option value="13">13</option>
                                                                    </>
                                                                ) : (
                                                                    // Adult footwear sizes (UK/India sizes 6-12)
                                                                    <>
                                                                        <option value="6">6</option>
                                                                        <option value="7">7</option>
                                                                        <option value="8">8</option>
                                                                        <option value="9">9</option>
                                                                        <option value="10">10</option>
                                                                        <option value="11">11</option>
                                                                        <option value="12">12</option>
                                                                    </>
                                                                )
                                                            ) : isBangleCategory() ? (
                                                                // Bangle sizes (in inches)
                                                                <>
                                                                    <option value="2.0">2.0"</option>
                                                                    <option value="2.25">2.25"</option>
                                                                    <option value="2.5">2.5"</option>
                                                                    <option value="2.75">2.75"</option>
                                                                    <option value="3.0">3.0"</option>
                                                                    <option value="3.25">3.25"</option>
                                                                    <option value="3.5">3.5"</option>
                                                                    <option value="3.75">3.75"</option>
                                                                    <option value="4.0">4.0"</option>
                                                                    <option value="4.25">4.25"</option>
                                                                    <option value="4.5">4.5"</option>
                                                                    <option value="4.75">4.75"</option>
                                                                    <option value="5.0">5.0"</option>
                                                                </>
                                                            ) : isRingCategory() ? (
                                                                // Ring sizes (numeric sizes)
                                                                <>
                                                                    <option value="4">4</option>
                                                                    <option value="5">5</option>
                                                                    <option value="6">6</option>
                                                                    <option value="7">7</option>
                                                                    <option value="8">8</option>
                                                                    <option value="9">9</option>
                                                                    <option value="10">10</option>
                                                                    <option value="11">11</option>
                                                                    <option value="12">12</option>
                                                                    <option value="13">13</option>
                                                                    <option value="14">14</option>
                                                                </>
                                                            ) : isFashionCategory() ? (
                                                                isBottomwearCategory() ? (
                                                                    isMenBottomwearCategory() ? (
                                                                        // Men's bottomwear sizes (waist sizes in inches)
                                                                        <>
                                                                            <option value="28">28</option>
                                                                            <option value="30">30</option>
                                                                            <option value="32">32</option>
                                                                            <option value="34">34</option>
                                                                            <option value="36">36</option>
                                                                            <option value="38">38</option>
                                                                            <option value="40">40</option>
                                                                            <option value="42">42</option>
                                                                            <option value="44">44</option>
                                                                        </>
                                                                    ) : (
                                                                        // Women's bottomwear sizes (waist sizes in inches)
                                                                        <>
                                                                            <option value="24">24</option>
                                                                            <option value="26">26</option>
                                                                            <option value="28">28</option>
                                                                            <option value="30">30</option>
                                                                            <option value="32">32</option>
                                                                            <option value="34">34</option>
                                                                            <option value="36">36</option>
                                                                            <option value="38">38</option>
                                                                        </>
                                                                    )
                                                                ) : isInfantFashionCategory() ? (
                                                                    // Infant clothing sizes (age-based)
                                                                    <>
                                                                        <option value="0M-3M">0M-3M</option>
                                                                        <option value="3M-6M">3M-6M</option>
                                                                        <option value="6M-9M">6M-9M</option>
                                                                        <option value="9M-12M">9M-12M</option>
                                                                        <option value="12M-18M">12M-18M</option>
                                                                        <option value="18M-24M">18M-24M</option>
                                                                        <option value="Newborn">Newborn</option>
                                                                        <option value="2T">2T</option>
                                                                        <option value="3T">3T</option>
                                                                        <option value="4T">4T</option>
                                                                    </>
                                                                ) : isKidsFashionCategory() ? (
                                                                    // Kids clothing sizes (Boys/Girls: age-based)
                                                                    <>
                                                                        <option value="0M-3M">0M-3M</option>
                                                                        <option value="3M-6M">3M-6M</option>
                                                                        <option value="6M-9M">6M-9M</option>
                                                                        <option value="9M-12M">9M-12M</option>
                                                                        <option value="12M-18M">12M-18M</option>
                                                                        <option value="18M-24M">18M-24M</option>
                                                                        <option value="Newborn">Newborn</option>
                                                                        <option value="2Y-4Y">2Y-4Y</option>
                                                                        <option value="4Y-6Y">4Y-6Y</option>
                                                                        <option value="6Y-8Y">6Y-8Y</option>
                                                                        <option value="8Y-10Y">8Y-10Y</option>
                                                                        <option value="10Y-12Y">10Y-12Y</option>
                                                                        <option value="12Y-14Y">12Y-14Y</option>
                                                                        <option value="14Y+">14Y+</option>
                                                                    </>
                                                                ) : (
                                                                    // Adult fashion sizes (clothing)
                                                                    <>
                                                                        <option value="XS">XS - Extra Small</option>
                                                                        <option value="S">S - Small</option>
                                                                        <option value="M">M - Medium</option>
                                                                        <option value="L">L - Large</option>
                                                                        <option value="XL">XL - Extra Large</option>
                                                                        <option value="XXL">XXL - Extra Extra Large</option>
                                                                        <option value="XXXL">XXXL - Extra Extra Extra Large</option>
                                                                    </>
                                                                )
                                                            ) : (
                                                                // Default: Adult fashion sizes (clothing)
                                                                <>
                                                                    <option value="XS">XS - Extra Small</option>
                                                                    <option value="S">S - Small</option>
                                                                    <option value="M">M - Medium</option>
                                                                    <option value="L">L - Large</option>
                                                                    <option value="XL">XL - Extra Large</option>
                                                                    <option value="XXL">XXL - Extra Extra Large</option>
                                                                    <option value="XXXL">XXXL - Extra Extra Extra Large</option>
                                                                </>
                                                            )}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                                            Available Colors
                                                        </label>
                                                        <div className="flex items-center space-x-1 flex-wrap gap-1 mb-2">
                                                            {[
                                                                { name: 'Red', value: '#D0021B' },
                                                                { name: 'Orange', value: '#ff9900' },
                                                                { name: 'Blue', value: '#0000ff' },
                                                                { name: 'Purple', value: '#800080' },
                                                                { name: 'Pink', value: '#ff1493' },
                                                                { name: 'Yellow', value: '#ffff00' },
                                                                { name: 'Green', value: '#00ff00' },
                                                                { name: 'Skyblue', value: '#87CEEB' },
                                                                { name: 'Brown', value: '#8b4513' },
                                                                { name: 'Black', value: '#000000' },
                                                                { name: 'Gray', value: '#808080' },
                                                                { name: 'White', value: '#ffffff' },
                                                            ].map((color) => (
                                                                <button
                                                                    key={color.value}
                                                                    type="button"
                                                                    onClick={() => handleVariationChange(originalIndex, 'color', color.value)}
                                                                    className={`w-8 h-8 rounded-full border transition-all ${
                                                                        (variation.color || variationColors[originalIndex]) === color.value
                                                                            ? 'border-blue-500 ring-1 ring-blue-300'
                                                                            : 'border-gray-300 hover:border-gray-400'
                                                                    }`}
                                                                    style={{ backgroundColor: color.value }}
                                                                    title={color.name}
                                                                />
                                                            ))}
                                                            <button
                                                                type="button"
                                                                onClick={() => {
                                                                    const newState = { ...variationColorPickers };
                                                                    newState[originalIndex] = !newState[originalIndex];
                                                                    setVariationColorPickers(newState);
                                                                }}
                                                                className="w-8 h-8 rounded-full border border-dashed border-gray-300 flex items-center justify-center hover:border-gray-400 transition-colors"
                                                                title="Custom Color"
                                                            >
                                                                <PlusIcon className="h-4 w-4 text-gray-400" />
                                                            </button>
                                                        </div>
                                                        {variationColorPickers[originalIndex] && (
                                                            <div className="absolute z-10 mt-1">
                                                                <div className="fixed inset-0" onClick={() => {
                                                                    const newState = { ...variationColorPickers };
                                                                    newState[originalIndex] = false;
                                                                    setVariationColorPickers(newState);
                                                                }}></div>
                                                                <div className="relative">
                                                                    <SketchPicker
                                                                        color={variation.color || variationColors[originalIndex] || '#ffffff'}
                                                                        onChange={(color) => handleVariationColorChange(originalIndex, color)}
                                                                        width="220px"
                                                                    />
                                                                </div>
                                                            </div>
                                                        )}
                                                        <div className="flex items-center space-x-2">
                                                            <span className="text-sm text-gray-700">Selected Color:</span>
                                                            {(variation.color || variationColors[originalIndex]) ? (
                                                                <>
                                                                    <div
                                                                        className="w-5 h-5 rounded-full border border-gray-300"
                                                                        style={{ backgroundColor: variation.color || variationColors[originalIndex] }}
                                                                    />
                                                                    <span className="text-sm text-gray-700">
                                                                        {[
                                                                            { name: 'Red', value: '#D0021B' },
                                                                            { name: 'Orange', value: '#ff9900' },
                                                                            { name: 'Blue', value: '#0000ff' },
                                                                            { name: 'Purple', value: '#800080' },
                                                                            { name: 'Pink', value: '#ff1493' },
                                                                            { name: 'Yellow', value: '#ffff00' },
                                                                            { name: 'Green', value: '#00ff00' },
                                                                            { name: 'Skyblue', value: '#87CEEB' },
                                                                            { name: 'Brown', value: '#8b4513' },
                                                                            { name: 'Black', value: '#000000' },
                                                                            { name: 'Gray', value: '#808080' },
                                                                            { name: 'White', value: '#ffffff' },
                                                                        ].find(c => c.value === (variation.color || variationColors[originalIndex]))?.name || (variation.color || variationColors[originalIndex])}
                                                                    </span>
                                                                </>
                                                            ) : (
                                                                <span className="text-sm text-gray-400">No color selected</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                                            Stock Quantity
                                                        </label>
                                                        <input
                                                            type="number"
                                                            value={variation.stock_quantity || 0}
                                                            onChange={(e) => handleVariationChange(originalIndex, 'stock_quantity', parseInt(e.target.value) || 0)}
                                                            min="0"
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                        />
                                                    </div>
                                                    <div className="flex items-end">
                                                        <div className="flex items-center space-x-4 w-full">
                                                            <div className="flex items-center">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={variation.in_stock !== false}
                                                                    onChange={(e) => handleVariationChange(originalIndex, 'in_stock', e.target.checked)}
                                                                    className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                                                />
                                                                <label className="ml-2 block text-sm text-gray-900">
                                                                    In Stock
                                                                </label>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={() => handleRemoveVariation(originalIndex)}
                                                                className="text-red-600 hover:text-red-800"
                                                            >
                                                                <TrashIcon className="h-5 w-5" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Variation-Specific Media Management */}
                                                <div className="mt-4 border-t pt-4">
                                                    <div className="flex items-center justify-between mb-3">
                                                        <h5 className="text-sm font-semibold text-gray-800">
                                                            Variation Media
                                                            {variation.color && (
                                                                <span className="ml-2 text-xs font-normal text-gray-500">
                                                                    (Color: {variation.color})
                                                                </span>
                                                            )}
                                                        </h5>
                                                    </div>
                                                    
                                                    {/* Variation Dropzone Component */}
                                                    {(() => {
                                                        const VariationDropzone = () => {
                                                            const { getRootProps, getInputProps, isDragActive } = useDropzone({
                                                                onDrop: (acceptedFiles) => handleVariationMediaDrop(acceptedFiles, originalIndex, variation),
                                                                accept: {
                                                                    'image/*': ['.jpeg', '.jpg', '.png', '.gif', '.webp'],
                                                                    'video/*': ['.mp4', '.mov', '.avi']
                                                                },
                                                                multiple: true,
                                                                disabled: uploadingVariationMedia[originalIndex] || false
                                                            });

                                                            const variationMedia = media.filter((m: any) => {
                                                                // Skip media without variation_id (general product media)
                                                                if (!m.variation_id) {
                                                                    return false;
                                                                }
                                                                
                                                                // Handle both string and number comparisons for variation_id
                                                                const mediaVariationId = m.variation_id;
                                                                const variationId = variation.id;
                                                                
                                                                // If variation has an ID, match it with media's variation_id (handle both string and number)
                                                                if (variationId) {
                                                                    // Convert both to strings for comparison to handle type mismatches
                                                                    return String(mediaVariationId) === String(variationId);
                                                                }
                                                                
                                                                // If variation doesn't have an ID yet (new variation), check for temp ID
                                                                return String(mediaVariationId) === `temp-${originalIndex}`;
                                                            });
                                                            const pendingFiles = pendingVariationMedia[originalIndex] || [];
                                                            const hasMedia = variationMedia.length > 0 || pendingFiles.length > 0;

                                                            return (
                                                                <>
                                                                    {/* Drag and Drop Area */}
                                                                    <div
                                                                        {...getRootProps()}
                                                                        className={`border-2 border-dashed rounded-lg p-4 text-center cursor-pointer transition-colors mb-3 ${
                                                                            isDragActive
                                                                                ? 'border-indigo-500 bg-indigo-50'
                                                                                : 'border-gray-300 hover:border-indigo-400 hover:bg-gray-50'
                                                                        } ${uploadingVariationMedia[originalIndex] ? 'opacity-50 cursor-not-allowed' : ''}`}
                                                                    >
                                                                        <input {...getInputProps()} disabled={uploadingVariationMedia[originalIndex]} />
                                                                        <div className="space-y-1">
                                                                            {isDragActive ? (
                                                                                <p className="text-xs text-indigo-600 font-medium">Drop the files here...</p>
                                                                            ) : (
                                                                                <>
                                                                                    <p className="text-xs text-gray-600">
                                                                                        <span className="font-medium text-indigo-600">Click to upload</span> or drag and drop media here
                                                                                    </p>
                                                                                    <p className="text-xs text-gray-500">
                                                                                        Images (JPEG, PNG, GIF, WEBP) or Videos (MP4, MOV, AVI)
                                                                                    </p>
                                                                                </>
                                                                            )}
                                                                        </div>
                                                                    </div>

                                                                    {/* Uploading Indicator */}
                                                                    {uploadingVariationMedia[originalIndex] && (
                                                                        <div className="mb-3 text-xs text-indigo-600 text-center">
                                                                            Uploading media...
                                                                        </div>
                                                                    )}

                                                                    {/* Pending Files Preview */}
                                                                    {pendingFiles.length > 0 && (
                                                                        <div className="mb-3">
                                                                            <p className="text-xs text-gray-600 mb-2 font-medium">Pending Upload ({pendingFiles.length}):</p>
                                                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                                                {pendingFiles.map((file, fileIndex) => (
                                                                                    <div key={`pending-${originalIndex}-${fileIndex}`} className="relative group">
                                                                                        {file.type.startsWith('image/') ? (
                                                                                            <img
                                                                                                src={URL.createObjectURL(file)}
                                                                                                alt={`Preview ${fileIndex}`}
                                                                                                className="w-full h-20 object-cover rounded border border-gray-200"
                                                                                            />
                                                                                        ) : (
                                                                                            <div className="w-full h-20 bg-gray-100 rounded border border-gray-200 flex items-center justify-center">
                                                                                                <VideoCameraIcon className="h-6 w-6 text-gray-400" />
                                                                                            </div>
                                                                                        )}
                                                                                        <button
                                                                                            type="button"
                                                                                            onClick={(e) => {
                                                                                                e.stopPropagation();
                                                                                                removePendingVariationFile(originalIndex, file);
                                                                                            }}
                                                                                            className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                                                        >
                                                                                            <XMarkIcon className="h-3 w-3" />
                                                                                        </button>
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        </div>
                                                                    )}

                                                                    {/* Uploaded Media Display */}
                                                                    {hasMedia ? (
                                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                                {variationMedia.map((item: any) => (
                                                                    <div key={item.id} className="relative group">
                                                                        {item.type === 'image' ? (
                                                                            <img
                                                                                src={item.url || (item.file_path ? `/storage/${item.file_path}` : '/placeholder-image.png')}
                                                                                alt={item.file_name || 'Variation image'}
                                                                                className="w-full h-20 object-cover rounded border border-gray-200"
                                                                                onError={(e) => {
                                                                                    (e.target as HTMLImageElement).src = '/placeholder-image.png';
                                                                                }}
                                                                            />
                                                                        ) : (
                                                                            <video
                                                                                src={item.url || (item.file_path ? `/storage/${item.file_path}` : '')}
                                                                                className="w-full h-20 object-cover rounded border border-gray-200"
                                                                                controls
                                                                            />
                                                                        )}
                                                                        <button
                                                                            type="button"
                                                                            onClick={() => handleDeleteMedia(item.id)}
                                                                            className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                                                        >
                                                                            <TrashIcon className="h-3 w-3" />
                                                                        </button>
                                                                        {item.color && (
                                                                            <div className="absolute bottom-1 left-1 px-1 py-0.5 bg-black bg-opacity-50 rounded text-xs text-white">
                                                                                {item.color}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                                    ) : (
                                                                        <p className="text-xs text-gray-400 italic text-center">
                                                                            No media uploaded for this variation. Drag and drop or click to upload.
                                                                        </p>
                                                                    )}
                                                                </>
                                                            );
                                                        };

                                                        return <VariationDropzone />;
                                                    })()}
                                                </div>
                                            </div>
                                                );
                                            })}
                                    </div>
                                ) : (
                                    <p className="text-sm text-gray-500">No variations added. Click "Add Variation" to create one.</p>
                                )}
                                    </div>
                                )}
                            </div>

                            {/* Fabric Management - Only for Fashion Category */}
                            {isFashionCategory() && (
                                <div className="border-t pt-6">
                                    <div className="mb-4">
                                        <h3 className="text-lg font-medium text-gray-900 mb-2">Product Fabrics</h3>
                                        <p className="text-sm text-gray-500">
                                            Select fabrics available for this fashion product. Manage fabrics from the <Link href="/admin/fabrics" className="text-indigo-600 hover:text-indigo-700 underline">Fabrics section</Link>.
                                        </p>
                                    </div>

                                    {loadingFabrics ? (
                                        <div className="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center">
                                            <p className="text-sm text-gray-500">Loading fabrics...</p>
                                        </div>
                                    ) : availableFabrics.length > 0 ? (
                                        <div className="mb-4">
                                            <h4 className="text-sm font-semibold text-gray-700 mb-3">
                                                Available Fabrics ({selectedFabricIds.length} selected)
                                            </h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto p-3 bg-gray-50 rounded-lg border border-gray-200">
                                                {availableFabrics.map((fabric: any) => {
                                                    const isSelected = selectedFabricIds.includes(fabric.id);
                                                    return (
                                                        <label
                                                            key={fabric.id}
                                                            className={`p-3 rounded-lg border-2 cursor-pointer transition-all ${
                                                                isSelected
                                                                    ? 'border-indigo-500 bg-indigo-50'
                                                                    : 'border-gray-300 bg-white hover:border-indigo-400 hover:bg-indigo-50'
                                                            }`}
                                                        >
                                                            <div className="flex items-start">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={isSelected}
                                                                    onChange={() => handleToggleFabric(fabric.id)}
                                                                    className="mt-1 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                                                />
                                                                <div className="ml-3 flex-1">
                                                                    <p className={`font-medium text-sm ${isSelected ? 'text-indigo-900' : 'text-gray-900'}`}>
                                                                        {fabric.fabric_name}
                                                                    </p>
                                                                    {fabric.description && (
                                                                        <p className="text-xs text-gray-600 mt-1">{fabric.description}</p>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </label>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                            <p className="text-sm text-gray-500 text-center">
                                                No fabrics available. <Link href="/admin/fabrics" className="text-indigo-600 hover:text-indigo-700 underline">Create fabrics</Link> first.
                                            </p>
                                        </div>
                                    )}

                                    {selectedFabricIds.length > 0 && (
                                        <div className="mt-4 p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                                            <p className="text-sm text-indigo-900">
                                                <span className="font-semibold">{selectedFabricIds.length}</span> fabric{selectedFabricIds.length !== 1 ? 's' : ''} selected
                                            </p>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Stock Quantity - After Variations */}
                            <div className="border-t pt-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Stock Quantity <span className="text-red-500">*</span>
                                        {variations.length > 0 && (
                                            <span className="ml-2 text-xs text-gray-500 font-normal">(Auto-calculated from variations)</span>
                                        )}
                                    </label>
                                    <input
                                        type="number"
                                        name="total_quantity"
                                        value={formData.total_quantity}
                                        onChange={handleInputChange}
                                        required
                                        min="0"
                                        disabled={variations.length > 0}
                                        className={`w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                                            errors.total_quantity ? 'border-red-300' : 'border-gray-300'
                                        } ${variations.length > 0 ? 'bg-gray-100 cursor-not-allowed' : ''}`}
                                        placeholder="0"
                                    />
                                    {variations.length > 0 && (
                                        <p className="mt-1 text-xs text-gray-500">
                                            Total stock is automatically calculated from all variation stock quantities. To change it, modify individual variation stocks.
                                        </p>
                                    )}
                                    {variations.length === 0 && (
                                        <p className="mt-1 text-xs text-gray-500">
                                            Enter the total stock quantity for this product. If you add variations, this will be auto-calculated.
                                        </p>
                                    )}
                                    {errors.total_quantity && (
                                        <p className="mt-1 text-sm text-red-600">{errors.total_quantity}</p>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Form Actions */}
                        <div className="mt-8 flex justify-end space-x-4 border-t pt-6">
                            <button
                                type="button"
                                onClick={() => router.visit('/admin/products')}
                                className="px-6 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            >
                                {isEditMode || product?.id ? 'Back to Products' : 'Cancel'}
                            </button>
                            <button
                                type="submit"
                                disabled={submitting}
                                className="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {submitting ? 'Saving...' : isEditMode || product?.id ? 'Update Product' : 'Create Product'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </AdminLayout>
    );
}

